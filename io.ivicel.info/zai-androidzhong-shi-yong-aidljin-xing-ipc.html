<!DOCTYPE html>
<html lang="zh" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>在Android中使用AIDL进行IPC - Amber time</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="./zai-androidzhong-shi-yong-aidljin-xing-ipc.html">

        <meta name="author" content="ivicel" />
        <meta name="keywords" content="aidl,ipc,进程间通信" />
        <meta name="description" content="AIDL基本介绍 AIDL全称Android Interface Define Language, 后缀名是.aidl. 其支持以下几个数据类型 基本数据类型int, float, long, double, byte , short, boolean, char String类型和CharSequence类型 List类型, 并其内元素可以是泛型. 但元素一定是可Parcelable类型或是其他AIDL支持的类型. 可选择将 List 用作 “通用” 类（例如，List&lt;String&gt;）。另一端实际接收的具体类始终是 ArrayList，但生成的方法使用的是 List 接口。 Map类型 …" />

        <meta property="og:site_name" content="Amber time" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="在Android中使用AIDL进行IPC"/>
        <meta property="og:url" content="./zai-androidzhong-shi-yong-aidljin-xing-ipc.html"/>
        <meta property="og:description" content="AIDL基本介绍 AIDL全称Android Interface Define Language, 后缀名是.aidl. 其支持以下几个数据类型 基本数据类型int, float, long, double, byte , short, boolean, char String类型和CharSequence类型 List类型, 并其内元素可以是泛型. 但元素一定是可Parcelable类型或是其他AIDL支持的类型. 可选择将 List 用作 “通用” 类（例如，List&lt;String&gt;）。另一端实际接收的具体类始终是 ArrayList，但生成的方法使用的是 List 接口。 Map类型 …"/>
        <meta property="article:published_time" content="2018-04-01" />
            <meta property="article:section" content="Android" />
            <meta property="article:tag" content="aidl" />
            <meta property="article:tag" content="ipc" />
            <meta property="article:tag" content="进程间通信" />
            <meta property="article:author" content="ivicel" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/default.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
Amber time            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li class="active">
                            <a href="./category/android.html">Android</a>
                        </li>
                        <li >
                            <a href="./category/c-language.html">C language</a>
                        </li>
                        <li >
                            <a href="./category/data-structure-algorithms.html">Data structure algorithms</a>
                        </li>
                        <li >
                            <a href="./category/database.html">Database</a>
                        </li>
                        <li >
                            <a href="./category/java.html">Java</a>
                        </li>
                        <li >
                            <a href="./category/javascript.html">Javascript</a>
                        </li>
                        <li >
                            <a href="./category/python.html">Python</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./zai-androidzhong-shi-yong-aidljin-xing-ipc.html"
                       rel="bookmark"
                       title="Permalink to 在Android中使用AIDL进行IPC">
                        在Android中使用AIDL进行IPC
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2018-04-01T00:00:00+08:00"> Sun 01 April 2018</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="./tag/aidl.html">aidl</a>
        /
	<a href="./tag/ipc.html">ipc</a>
        /
	<a href="./tag/jin-cheng-jian-tong-xin.html">进程间通信</a>
        
</footer><!-- /.post-info -->                    </div>
                </div>
                <h5 id="aidl"><code>AIDL</code>基本介绍</h5>
<p><code>AIDL</code>全称<code>Android Interface Define Language</code>, 后缀名是<code>.aidl</code>. 其支持以下几个数据类型</p>
<ul>
<li>基本数据类型<code>int</code>, <code>float</code>, <code>long</code>, <code>double</code>, <code>byte</code> , <code>short</code>, <code>boolean</code>, <code>char</code></li>
<li><code>String</code>类型和<code>CharSequence</code>类型</li>
<li><code>List</code>类型,  并其内<strong>元素</strong>可以是<strong>泛型</strong>. 但元素一定是可<code>Parcelable</code>类型或是其他<code>AIDL</code>支持的类型. 可选择将 <code>List</code> 用作 “通用” 类（例如，<code>List&lt;String&gt;</code>）。另一端实际接收的具体类始终是 <code>ArrayList</code>，但生成的方法使用的是 <code>List</code> 接口。</li>
<li><code>Map</code>类型. 并其内元素不能是泛型, 元素一定<code>AIDL</code>支持的类型, 或者可<code>Parcelable</code>或者其他<code>AIDL</code>接口. 不支持通用 <code>Map</code>（如<code>Map&lt;String,Integer&gt;</code> 形式的 Map）。 另一端实际接收的具体类始终是 <code>HashMap</code>，但生成的方法使用的是 <code>Map</code> 接口。</li>
</ul>
<p>一般有两种<code>.aidl</code>文件. 一种是定义可<code>Parcelable</code>的数据结构. 一种是定义方法接口.数据结构需要由我们自己来实现, 一般也会写在包内. 而接口方法由系统生成固定的接口, 然后在需要的地方再实现具体的业务逻辑, 实现该接口即可</p>
<p>一般我们会把<code>AIDL</code>文件全部都定义在一个<code>package</code>内. 这样才发送给客户端时, 只需把整个包发给他就 OK了. 但即使在同一个包内的<code>aidl</code>文件在使用其他包内的数据时也是要<code>import</code>才行.</p>
<p>在接口方法中定义的参数都必须带有<code>tag</code>标志们, <code>Primitives</code>基本类型和<code>String</code>和<code>CharSequence</code>默认是<code>in</code>而且只能是<code>in</code>. 其他可以为<code>in</code>, <code>out</code>, <code>inout</code>. 后面详解这三个<code>tag</code></p>
<h5 id="aidl_1"><code>AIDL</code>简单使用示例</h5>
<p>首先定义两个<code>AIDL</code>文件</p>
<div class="highlight"><pre><span></span>// Book.aidl
package info.ivicel.github.aidldemo;

// 注意是小写
parcelable Book;
</pre></div>


<div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">info</span><span class="o">.</span><span class="n">ivicel</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">aidldemo</span><span class="p">;</span>

<span class="o">//</span> <span class="err">非基本数据类型需要导入</span>
<span class="kn">import</span> <span class="nn">info.ivicel.github.aidldemo.Book</span><span class="p">;</span>

<span class="n">interface</span> <span class="n">BookManager</span> <span class="p">{</span>
    <span class="o">//</span> <span class="err">测试不同的</span> <span class="n">tag</span> <span class="err">标志的影响</span>
    <span class="o">//</span> <span class="err">返回值不需要</span> <span class="n">tag</span>
    <span class="n">Book</span> <span class="n">addBookIn</span><span class="p">(</span><span class="ow">in</span> <span class="n">Book</span> <span class="n">book</span><span class="p">);</span>
    <span class="n">Book</span> <span class="n">addBookOut</span><span class="p">(</span><span class="n">out</span> <span class="n">Book</span> <span class="n">book</span><span class="p">);</span>
    <span class="n">Book</span> <span class="n">addBookInout</span><span class="p">(</span><span class="n">inout</span> <span class="n">Book</span> <span class="n">book</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>再定义<code>Book.aidl</code>的实现<code>Book.java</code>. 需要注意的两点: 
一是如果把<code>Book.java</code>定义在<code>aidl</code>包中, 一定要向<code>build.gradle</code>添加查找<code>java</code>文件的路径.</p>
<div class="highlight"><pre><span></span>android {
    // .....
    sourceSets {
        main {
            java.srcDirs = [&#39;src/main/java&#39;, &#39;src/main/aidl&#39;]
        }
    }
    // .....
}
</pre></div>


<p>二是默认的<code>Parcelable</code>接口并不要求实现<code>readFromParcel</code>方法, 但在<code>AIDL</code>中, <code>tag</code>标签的<code>out</code>,<code>inout</code>需要其来实现写入流, 如果不实现这个方法, 则只能为<code>in</code></p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">info.ivicel.github.aidldemo</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">android.os.Parcel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Parcelable</span><span class="o">;</span>

<span class="c1">// 如果 java 的实现类是放在和 aidl 同一个包内</span>
<span class="c1">// 一定不能忘了把 java 源码的路径加入到 build.gradle 中, 否则会找不到文件</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Book</span> <span class="kd">implements</span> <span class="n">Parcelable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">price</span><span class="o">;</span>

    <span class="c1">// 需要显示的定义一个无参的 constructor</span>
    <span class="kd">public</span> <span class="nf">Book</span><span class="o">()</span> <span class="o">{}</span>

    <span class="c1">// getter and setter...</span>

    <span class="kd">protected</span> <span class="nf">Book</span><span class="o">(</span><span class="n">Parcel</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">readFromParcel</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Creator</span><span class="o">&lt;</span><span class="n">Book</span><span class="o">&gt;</span> <span class="n">CREATOR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Creator</span><span class="o">&lt;</span><span class="n">Book</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Book</span> <span class="nf">createFromParcel</span><span class="o">(</span><span class="n">Parcel</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Book</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Book</span><span class="o">[]</span> <span class="nf">newArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Book</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">describeContents</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeToParcel</span><span class="o">(</span><span class="n">Parcel</span> <span class="n">dest</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">dest</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">price</span><span class="o">);</span>
        <span class="n">dest</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 默认的 Parcelable 是没有规定要实现 readFromParcel 方法</span>
    <span class="c1">// 但如果不实现这个方法, Book 的 tag 只能为 in</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">readFromParcel</span><span class="o">(</span><span class="n">Parcel</span> <span class="n">dest</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="na">readString</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>以上三个文件<code>Book.aidl</code>, <code>Book.java</code>, <code>BookManager.aidl</code>在<code>client</code>和<code>server</code>端都必须有一份.</p>
<p>在<code>rebuild</code>,或是<code>clean</code>之后, 会在应用目录<code>build/source/aidl</code>下生成同名接口的<code>java</code>文件. 我们只要在<code>server</code>端根据具体的业务逻辑实现该接口中的方法即可. 然后使用<code>Service</code>来监听来自<code>client</code>的请求. 在<code>client</code>端来调用接口中的方法与<code>server</code>端进行通信</p>
<p>在<code>Server</code>端实现一个<code>Service</code></p>
<div class="highlight"><pre><span></span><span class="c1">// AIDLService.java</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AIDLService</span> <span class="kd">extends</span> <span class="n">Service</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TAG</span> <span class="o">=</span> <span class="s">&quot;AIDLService&quot;</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Book</span><span class="o">&gt;</span> <span class="n">books</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="c1">// 由 AIDL 文件生成的 BookManager 接口的实现</span>
    <span class="c1">// 一般会有多个 client 连接到 server, 所以需要对 server 中的数据处理同步问题</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">BookManager</span><span class="o">.</span><span class="na">Stub</span> <span class="n">bookManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BookManager</span><span class="o">.</span><span class="na">Stub</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Book</span><span class="o">&gt;</span> <span class="nf">getBooks</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">books</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">books</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Book</span> <span class="nf">getBook</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">books</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="n">Random</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
                <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">books</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
                <span class="k">return</span> <span class="n">books</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getBookCount</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">books</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">books</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// ... </span>
    <span class="o">};</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;onCreate: &quot;</span><span class="o">);</span>
        <span class="n">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Book</span><span class="o">();</span>
        <span class="n">book</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;Android开发艺术探索&quot;</span><span class="o">);</span>
        <span class="n">book</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="mi">28</span><span class="o">);</span>
        <span class="n">books</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>

        <span class="n">book</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Book</span><span class="o">();</span>
        <span class="n">book</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;Android编程权威指南&quot;</span><span class="o">);</span>
        <span class="n">book</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="mi">55</span><span class="o">);</span>
        <span class="n">books</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Nullable</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">IBinder</span> <span class="nf">onBind</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;on bind, intent = %s&quot;</span><span class="o">,</span> <span class="n">intent</span><span class="o">.</span><span class="na">toString</span><span class="o">()));</span>
        <span class="k">return</span> <span class="n">bookManager</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>然后在<code>Manifest.xml</code>中定义<code>Service</code>, 如果<code>Client</code>是另一个程序的话, 需要定义一个隐式的<code>Intent-filter</code>来通知<code>Service</code>接收什么连接</p>
<div class="highlight"><pre><span></span><span class="c">&lt;!-- exported=true 表示能让非同应用的进程访问 --&gt;</span>
<span class="c">&lt;!-- 为了安全最好还是定义一个 permission, 让拥有权限的应用访问 --&gt;</span>
<span class="nt">&lt;service</span>
         <span class="na">android:name=</span><span class="s">&quot;.AIDLService&quot;</span>
         <span class="na">android:exported=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter&gt;</span>
        <span class="c">&lt;!-- 定义一个 action, client 请求时使用, 需一致 --&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;info.ivicel.github.aidldemo.aidl&quot;</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!-- 定义一个 category, java 代码中系统会自动给添加上一个 DEFAULT --&gt;</span>
        <span class="c">&lt;!-- 不定义会导致无法指收到请求. 或者定义其他的的 category --&gt;</span>
        <span class="nt">&lt;category</span> <span class="na">android:category=</span><span class="s">&quot;android.intent.category.DEFAULT&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/service&gt;</span>
</pre></div>


<p>在<code>Client</code>端, 我们可以通过<code>bindService()</code>来获得<code>BookManager</code>的引用</p>
<div class="highlight"><pre><span></span><span class="c1">// client </span>
<span class="c1">// MainActivity.java </span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">BookManager</span> <span class="n">bookManager</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">bound</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">ServiceConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServiceConnection</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceConnected</span><span class="o">(</span><span class="n">ComponentName</span> <span class="n">name</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 在 bindService 之后我们就可以拿到 binder</span>
            <span class="c1">// 转为在 aidl 中定义好的接口, 就可以使用接口的方法</span>
            <span class="n">bookManager</span> <span class="o">=</span> <span class="n">BookManager</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onServiceDisconnected</span><span class="o">(</span><span class="n">ComponentName</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">bound</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">bookManager</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreated</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">saveInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreated</span><span class="o">(</span><span class="n">saveInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">bound</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">attempToBindService</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">attempToBindService</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="s">&quot;info.ivicel.github.aidldemo.aidl&quot;</span><span class="o">);</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">setPackage</span><span class="o">(</span><span class="s">&quot;info.ivicel.github.aidldemo&quot;</span><span class="o">);</span>
        <span class="n">bindService</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">connection</span><span class="o">,</span> <span class="n">Context</span><span class="o">.</span><span class="na">BIND_AUTO_CREATE</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onDestory</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bound</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">unbindService</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h5 id="aidlin-out-inout"><code>AIDL</code>方法参数<code>in</code>, <code>out</code>, <code>inout</code>意义</h5>
<p>这三个参数表示的是数据的流向, 都是从<code>client</code>来看<code>server</code>.</p>
<ul>
<li><code>in</code>表示数据从<code>client</code>流向<code>server</code>. <code>server</code>会从<code>client</code>接收到一个完整的对象, 但对该对象的修改不会使<code>client</code>端产生变化</li>
<li><code>out</code>表示数据从<code>server</code>流向<code>client</code>. <code>server</code>端会从<code>client</code>端接收到一个空对象, 对该对象的操作将反应到<code>client</code>传入的对象</li>
<li><code>inout</code>表示数据可双向流动, 以上两点的结合. 接收完整信息并反馈回<code>client</code></li>
</ul>
<p>依旧使用上一个例子来做一个实验</p>
<p>在<code>client</code>中使用三个不同的<code>tag</code>向<code>server</code>添加新的对象, 并在<code>server</code>中对其进行修改. 然后分别返回这个新的值. 这些过程都打对象打印出来作对比</p>
<div class="highlight"><pre><span></span><span class="c1">// client</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">addBookIn</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">checkServerService</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Book</span><span class="o">();</span>
    <span class="n">book</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;new_book_in&quot;</span><span class="o">);</span>
    <span class="n">book</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OnClient&quot;</span><span class="o">,</span> <span class="s">&quot;before addBookIn client book = &quot;</span> <span class="o">+</span> <span class="n">book</span><span class="o">);</span>
        <span class="n">Book</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">bookManager</span><span class="o">.</span><span class="na">addBookIn</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OnClient&quot;</span><span class="o">,</span> <span class="s">&quot;addBookIn return from server: &quot;</span> <span class="o">+</span> <span class="n">b2</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OnClient&quot;</span><span class="o">,</span> <span class="s">&quot;after addBookIn client book = &quot;</span> <span class="o">+</span> <span class="n">book</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">addBookOut</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">checkServerService</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Book</span><span class="o">();</span>
    <span class="n">book</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;new_book_out&quot;</span><span class="o">);</span>
    <span class="n">book</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="mi">21</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OnClient&quot;</span><span class="o">,</span> <span class="s">&quot;before addBookOut client book = &quot;</span> <span class="o">+</span> <span class="n">book</span><span class="o">);</span>
        <span class="n">Book</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">bookManager</span><span class="o">.</span><span class="na">addBookOut</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OnClient&quot;</span><span class="o">,</span> <span class="s">&quot;addBookOut return from server: &quot;</span> <span class="o">+</span> <span class="n">b2</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OnClient&quot;</span><span class="o">,</span> <span class="s">&quot;after addBookOut client book = &quot;</span> <span class="o">+</span> <span class="n">book</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">addBookInout</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">checkServerService</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">Book</span> <span class="n">book</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Book</span><span class="o">();</span>
    <span class="n">book</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;new_book_inout&quot;</span><span class="o">);</span>
    <span class="n">book</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="mi">22</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OnClient&quot;</span><span class="o">,</span> <span class="s">&quot;before addBookInOut client book = &quot;</span> <span class="o">+</span> <span class="n">book</span><span class="o">);</span>
        <span class="n">Book</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">bookManager</span><span class="o">.</span><span class="na">addBookInout</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OnClient&quot;</span><span class="o">,</span> <span class="s">&quot;addBookInOut return from server: &quot;</span> <span class="o">+</span> <span class="n">b2</span><span class="o">);</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OnClient&quot;</span><span class="o">,</span> <span class="s">&quot;after addBookInOut client book = &quot;</span> <span class="o">+</span> <span class="n">book</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// server </span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">BookManager</span><span class="o">.</span><span class="na">Stub</span> <span class="n">bookManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BookManager</span><span class="o">.</span><span class="na">Stub</span> <span class="o">{</span>
    <span class="c1">// ....</span>
    <span class="c1">// 在 server 中, 分别都对传入进来的 book 名称加上 &quot;_by_server`, 价格加 10, 然后返回</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Book</span> <span class="nf">addBookIn</span><span class="o">(</span><span class="n">Book</span> <span class="n">book</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OnServer&quot;</span><span class="o">,</span> <span class="s">&quot;addBookIn: &quot;</span> <span class="o">+</span> <span class="n">book</span><span class="o">);</span>
        <span class="n">book</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;_by_server&quot;</span><span class="o">);</span>
        <span class="n">book</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">getPrice</span><span class="o">()</span> <span class="o">+</span> <span class="mi">10</span><span class="o">);</span>
        <span class="n">books</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">book</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Book</span> <span class="nf">addBookOut</span><span class="o">(</span><span class="n">Book</span> <span class="n">book</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OnServer&quot;</span><span class="o">,</span> <span class="s">&quot;addBookOut: &quot;</span> <span class="o">+</span> <span class="n">book</span><span class="o">);</span>
        <span class="n">book</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;_by_server&quot;</span><span class="o">);</span>
        <span class="n">book</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">getPrice</span><span class="o">()</span> <span class="o">+</span> <span class="mi">10</span><span class="o">);</span>
        <span class="n">books</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">book</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Book</span> <span class="nf">addBookInout</span><span class="o">(</span><span class="n">Book</span> <span class="n">book</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;OnServer&quot;</span><span class="o">,</span> <span class="s">&quot;addBookInOut: &quot;</span> <span class="o">+</span> <span class="n">book</span><span class="o">);</span>
        <span class="n">book</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;_by_server&quot;</span><span class="o">);</span>
        <span class="n">book</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="n">book</span><span class="o">.</span><span class="na">getPrice</span><span class="o">()</span> <span class="o">+</span> <span class="mi">10</span><span class="o">);</span>
        <span class="n">books</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">book</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p><code>server</code>端打印的结果:</p>
<blockquote>
<p>OnServer: addBookIn: Book{name='new_book_in', price=20}
OnServer: addBookOut: Book{name='null', price=0}
OnServer: addBookInOut: Book{name='new_book_inout', price=22}</p>
</blockquote>
<p>可以看出来, <code>tag</code>为<code>in</code>时, 传进来的是一个完整的对象数据值. 为<code>out</code>时, 传进来的是一个默认初始化的对象. 为<code>inout</code>传进来的也是一个完整对象</p>
<p><code>client</code>端的打印结果:</p>
<p>首先是<code>tag</code>为<code>in</code>时. 返回的值说明<code>server</code>对对象有修改, 但<code>client</code>本身的原对象未发生变化. 说明<code>server</code>端是一个副本</p>
<blockquote>
<p>OnClient: before addBookIn client book = Book{name='new_book_in', price=20}
OnClient: addBookIn return from server: Book{name='new_book_in_by_server', price=30}
OnClient: after addBookIn client book = Book{name='new_book_in', price=20}</p>
</blockquote>
<p>当<code>tag</code>为<code>out</code>时, <code>server</code>接收到的是一个默认初始化的对象, 数据并不同于<code>client</code>端, 但在<code>server</code>修改后, <code>client</code>会同步变化</p>
<blockquote>
<p>OnClient: before addBookOut client book = Book{name='new_book_out', price=21}
OnClient: addBookOut return from server: Book{name='null_by_server', price=10}
OnClient: after addBookOut client book = Book{name='null_by_server', price=10}</p>
</blockquote>
<p>当<code>tag</code>为<code>inout</code>时, 是以上两种的结合</p>
<blockquote>
<p>OnClient: before addBookInOut client book = Book{name='new_book_inout', price=22}
OnClient: addBookInOut return from server: Book{name='new_book_inout_by_server', price=32}
OnClient: after addBookInOut client book = Book{name='new_book_inout_by_server', price=32}</p>
</blockquote>
<p>代码地址: <a href="https://github.com/ivicel/dev-android-samples/tree/master/AIDL-Demo">GitHub</a></p>
<h4 id="reference">Reference:</h4>
<ol>
<li>https://blog.csdn.net/luoyanglizi/article/details/51980630</li>
<li>https://blog.csdn.net/luoyanglizi/article/details/51958091</li>
<li>https://blog.csdn.net/luoyanglizi/article/details/52029091</li>
<li>&lt;<Android 开发艺术探索>&gt;</li>
<li>https://developer.android.com/guide/components/aidl.html?hl=zh-cn</li>
</ol>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
        <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="#"><i class="fa fa-you-can-add-links-in-your-config-file-square fa-lg"></i> You can add links in your config file</a></li>
                <li class="list-group-item"><a href="#"><i class="fa fa-another-social-link-square fa-lg"></i> Another social link</a></li>
              </ul>
            </li>





    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://getpelican.com/" target="_blank">
                Pelican
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://python.org/" target="_blank">
                Python.org
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://jinja.pocoo.org/" target="_blank">
                Jinja2
            </a>
        </li>
        <li class="list-group-item">
            <a href="#" target="_blank">
                You can modify those links in your config file
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 ivicel
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>


</body>
</html>