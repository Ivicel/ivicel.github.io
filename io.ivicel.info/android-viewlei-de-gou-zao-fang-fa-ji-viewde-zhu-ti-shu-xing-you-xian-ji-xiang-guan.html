
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="./theme/pygments/manni.min.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/font-awesome.min.css">

    <link href="./static/custom.css" rel="stylesheet">



    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-113622715-2', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

<meta name="author" content="ivicel" />
<meta name="description" content="1. layout 里 view 的属性赋值 一个 layout 文件里的 view 的属性可以在 5 个地方赋值, 优先级从高到低如下: layout 中对属性直接赋值 layout 中覆盖 view 的 style 构造方法里的 defStyleAttr 构造方法里的 defStyleRes, 这个当仅当 defStyleAttr 值为 0 , 或者其指定的 attr 值找不到(比如没设定) 定义/使用的主题里的值 在 layout 布局文件里对 view 直接赋值 xml &lt;TextView android:textColor=&#34;#332211&#34;/&gt; 自定义一个 style, 然后在 layout 里的 view …" />
<meta name="keywords" content="view, 构造方法, attrs, declare-styleable, style">

<meta property="og:site_name" content="Ivicel's Ambertime"/>
<meta property="og:title" content="Android View类的构造方法及View的主题属性优先级相关"/>
<meta property="og:description" content="1. layout 里 view 的属性赋值 一个 layout 文件里的 view 的属性可以在 5 个地方赋值, 优先级从高到低如下: layout 中对属性直接赋值 layout 中覆盖 view 的 style 构造方法里的 defStyleAttr 构造方法里的 defStyleRes, 这个当仅当 defStyleAttr 值为 0 , 或者其指定的 attr 值找不到(比如没设定) 定义/使用的主题里的值 在 layout 布局文件里对 view 直接赋值 xml &lt;TextView android:textColor=&#34;#332211&#34;/&gt; 自定义一个 style, 然后在 layout 里的 view …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="./android-viewlei-de-gou-zao-fang-fa-ji-viewde-zhu-ti-shu-xing-you-xian-ji-xiang-guan.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2018-04-22 00:00:00+08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="./author/ivicel.html">
<meta property="article:section" content="Android"/>
<meta property="article:tag" content="view"/>
<meta property="article:tag" content="构造方法"/>
<meta property="article:tag" content="attrs"/>
<meta property="article:tag" content="declare-styleable"/>
<meta property="article:tag" content="style"/>
<meta property="og:image" content="/images/favicon.ico">

  <title>Ivicel's Ambertime &ndash; Android View类的构造方法及View的主题属性优先级相关</title>

</head>
<body>
  <aside>
    <div>
      <a href=".">
        <img src="/images/favicon.ico" alt="Ambertime" title="Ambertime">
      </a>
      <h1><a href=".">Ambertime</a></h1>

<p>Make memory in past times</p>

      <ul class="social">
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href=".">Home</a>



    </nav>

<article class="single">
  <header>
      
    <h1 id="android-viewlei-de-gou-zao-fang-fa-ji-viewde-zhu-ti-shu-xing-you-xian-ji-xiang-guan">Android View类的构造方法及View的主题属性优先级相关</h1>
    <p>
      Posted on Sun 22 April 2018 in <a href="./category/android.html">Android</a>

    </p>
  </header>


  <div>
    <h3 id="1-layout-view">1. layout 里 view 的属性赋值</h3>
<p>一个 layout 文件里的 view 的属性可以在 5 个地方赋值, 优先级从高到低如下:</p>
<ul>
<li>layout 中对属性直接赋值  </li>
<li>layout 中覆盖 view 的 style </li>
<li>构造方法里的 defStyleAttr </li>
<li>构造方法里的 defStyleRes, 这个当仅当 defStyleAttr 值为 0 , 或者其指定的 attr 值找不到(比如没设定)</li>
<li>定义/使用的主题里的值 </li>
</ul>
<ol>
<li>在 <strong>layout</strong> 布局文件里对 view 直接赋值</li>
</ol>
<p><code>xml
   &lt;TextView
    android:textColor="#332211"/&gt;</code></p>
<ol>
<li>自定义一个 <code>style</code>, 然后在 <code>layout</code> 里的 <code>view</code> 使用 <code>style</code> 属性来覆盖. </li>
</ol>
<p>影响该 <code>view</code> 以及其子 <code>view</code>. 只有 <code>view</code> 有对应属性时才进行替换</p>
<p>```xml
   <style name="MyTextStyle">
       <item name="android:textColor">
   </style>
   <!-- 直接对 view 使用 -->
   <TextView
    style="@style/MyTextStyle"/>
   <!-- 对 ViewGroup 使用, 影响子 view -->
   <LinearLayout
    style="@style/MyTextStyle"></p>
<div class="codehilite"><pre><span></span>&lt;TextView
    android:text=&quot;inherit from ViewGroup textColor&quot;/&gt;

   &lt;!-- 没有 textColor 属性, 无影响 --&gt;
   &lt;ImageView
    android:src=&quot;@drawable/welcome.png&quot;/&gt;
</pre></div>


<p></LinearLayout></p>
<p>```</p>
<ol>
<li>Default Style Attribute (defStyleAttr)</li>
</ol>
<p>在 <code>TextView</code> 的源代码里有一个构造方法是这样的</p>
<p><code>java
   public TextView(Context context, @Nullable AttributeSet attrs) {
       this(context, attrs, com.android.internal.R.attr.textViewStyle);
   }</code></p>
<p><code>com.android.internal.R.attr.textViewStyle</code> 是一个 frameworks 层定义的 <a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/master/core/res/res/values/attrs.xml">attr</a>. </p>
<p><code>xml
   &lt;resources&gt;
       &lt;!-- These are the standard attributes that make up a complete theme. --&gt;
       &lt;declare-styleable name="Theme"&gt;
           &lt;!-- ... --&gt;
           &lt;!-- Default TextView style. --&gt;
           &lt;attr name="textViewStyle" format="reference" /&gt;
           &lt;!-- .... --&gt;
    &lt;declare-styleable&gt;
   &lt;/resources&gt;</code></p>
<p>可以看到这个 attr 类型是一个引用, 所以当我们这样定义一个 style item 时</p>
<p>```xml
   <style name="AppTheme" parent="Theme.AppCompat.Light.DarkActionBar">
       <item name="android:textColor">@android:color/holo_green_dark</item>
       <!-- 由于 defStyleAttr 的优先级比主题的高, 
        所以 textColor 被覆盖为 holo_blue_light, 即使上面定义了 textColor
    -->
       <item name="android:textViewStyle">@style/BlueTextStyle</item>
   </style></p>
<p><style name="BlueTextStyle">
       <item name="android:textColor">@android:color/holo_blue_light</item>
   </style>
   ```</p>
<ol>
<li>Default Style Resource (defStyleRes)</li>
</ol>
<p>构造方法 <code>public View(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes)</code> 是在 SDK 21 之后才有的, 但 defStyleRes 的值是早之前就有使用的. 这个是一个 <code>R.style.[name]</code> 值, 只有当 defStyleAttr 为 0 或者查找不到时才有效</p>
<blockquote>
<p>需要注意的是, <code>defStyleAttr</code> 里要求的是一个 format="reference" 的 attr, 但其实质上是一个整型值, 并且代码中没有用 @AttrRes 来注释, 所以随便传一个整型值时, 便可能是相当于 defStyleAttr 不存在. 同理 <code>defStyleRes</code> 要求的是一个 style id</p>
</blockquote>
<ol>
<li>在主题文件里赋值, 比如我们在 <code>styles.xml</code> 里自定义了一个主题 <code>AppTheme</code>. </li>
</ol>
<p>这个主题可以在 <code>activity</code> 里覆盖, 也可以设置为程序的默认主题</p>
<p>``` xml
   <!--比如我们在 styles.xml 里自定义一个主题, 覆盖 andorid:textColor 后, 
    使用该主题的 view 中有 android:textColor 这个属性的会使用我们设定的值
    因为我们定义的是一个应用的主题, 而不是单独某个 view 下的某些个属性
    所以这个主题需要继承系统的主题, 然后再覆盖, 下面继承的是 support 包里的兼容主题
    -->
   <style name="AppTheme" parent="Theme.AppCompat.Light.DarkActionBar">
       <item name="android:textColor">@color/myTextColor</item>
   </style></p>
<p><!-- 设置好一个程序的主题文件后, 我们可以在 AndroidManifest.xml 中引用 -->
   <!-- 应用全局主题 -->
   <application
    android:theme="@style/AppTheme"/></p>
<p><!-- 在 activity 配置里引用, 这会覆盖掉全局 application 里的设置 -->
   <activity
    android:theme="@style/AppTheme"/>
   ```</p>
<h3 id="2">2. 构造方法介绍</h3>
<p>以 SDK 27 中的 <code>ImageView</code> 为例, 一共有 4 个构造方法, 如下</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="nf">ImageView</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="n">initImageView</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">ImageView</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">AttributeSet</span> <span class="n">attrs</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">attrs</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">ImageView</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">AttributeSet</span> <span class="n">attrs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">defStyleAttr</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">defStyleAttr</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">ImageView</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">AttributeSet</span> <span class="n">attrs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">defStyleAttr</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">defStyleRes</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">defStyleAttr</span><span class="o">,</span> <span class="n">defStyleRes</span><span class="o">);</span>
    <span class="cm">/* .... */</span>
<span class="o">}</span>
</pre></div>


<p>构造方法最多有 4 个参数, 简单意思如下:</p>
<ul>
<li><code>context</code> 每个构造方法都有, 用来 inflate, 获取各种参数值等. 如果我们从 Java 代码中直接创建一个新的 view, 一般都是使用只有 context 的参数的构造方法</li>
<li><code>attrs</code> 这个是对布局文件 layout.xml 里的解析后生成的对象, 可以获取到 xml 里的配置</li>
<li><code>defStyleAttr</code> 属性引用</li>
<li><code>defStyleRes</code> SDK 21 后增加的. 如果 minSdkVersion &gt; 21 时才使用这个参数. 不然使用 <code>Theme#obtainStyledAttributes()</code> 也可以解析</li>
</ul>
<p>在 View inflate 后, 其所以设置属性都解析到了参数 attrs 中. 可以通过 <code>AttributeSet#getAttributeName()</code>, <code>AttributeSet#getAttributeValue()</code> 来获得名称和值. 但这个获得的只能是直接的值, 如果像 <code>android:text=@string/name"</code> 这样引用, android 内部都是通过 id 来查找, 所以也是获得一个 id 值, 所以我们总是用 <code>Theme</code> 类里的方法来一步解析, 这样可以直接找到对应的 string 值而不是 id</p>
<blockquote>
<p><code>Context</code> 中也有对应的方法, 其实质是调用了 context.getTeme.obtainStyledAttributes 而已</p>
</blockquote>
<div class="codehilite"><pre><span></span><span class="c1">// 从解析好的 AttributeSet 查找</span>
<span class="n">TypedArray</span> <span class="nf">obtainStyledAttributes</span><span class="o">(</span><span class="n">AttributeSet</span> <span class="n">set</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">attrs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">defStyleAttr</span><span class="o">,</span> 
        <span class="kt">int</span> <span class="n">defStyleRes</span><span class="o">)</span>
<span class="c1">// 从主题中查找</span>
<span class="n">TypedArray</span> <span class="nf">obtainStyledAttributes</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">attrs</span><span class="o">)</span>
<span class="c1">// 从指定的资源文件查找</span>
<span class="n">TypedArray</span> <span class="nf">obtainStyledAttributes</span><span class="o">(</span><span class="kt">int</span> <span class="n">resId</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">attrs</span><span class="o">)</span>
</pre></div>


<h3 id="reference">Reference:</h3>
<ol>
<li><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0806/4575.html">http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0806/4575.html</a></li>
<li><a href="https://blog.csdn.net/nbalichaoq/article/details/50550103">https://blog.csdn.net/nbalichaoq/article/details/50550103</a></li>
</ol>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/view.html">view</a>
      <a href="./tag/gou-zao-fang-fa.html">构造方法</a>
      <a href="./tag/attrs.html">attrs</a>
      <a href="./tag/declare-styleable.html">declare-styleable</a>
      <a href="./tag/style.html">style</a>
    </p>
  </div>





</article>

    <footer>
<p>
  &copy;  2018 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Ivicel's Ambertime ",
  "url" : ".",
  "image": "/images/favicon.ico",
  "description": "ivicel's thoughts and writings"
}
</script>

</body>
</html>