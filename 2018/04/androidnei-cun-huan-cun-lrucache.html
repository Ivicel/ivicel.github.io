<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta
            name="google-site-verification"
            content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI"
        />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, viewport-fit=cover"
        />
  
        <title>
Ambertime        </title>

        <!-- Web App Manifest -->
        <link rel="manifest" href="/assets/pwa/manifest.json" />

        <!-- Favicon -->
        <link rel="shortcut icon" href="/assets/images/favicon.ico"/>

        <!-- Canonical URL -->
        <link rel="canonical" href="" />

        <!-- Bootstrap Core CSS -->
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" />

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/theme/css/hux-blog.min.css" />
        <link rel="stylesheet" href="/assets/css/ivicel.css" />
        <!-- Custom Fonts -->
        <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
        <!-- Hux change font-awesome CDN to qiniu -->
        <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <!-- ga & ba script hoook -->
        <script></script>
    </head>


    <!-- hack iOS CSS :active style -->
    <body ontouchstart="">
<!-- Navigation -->
<!-- <nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"> -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Ambertime</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    <li>
                        <a href="pages/about/">About</a>
                    </li>
                    <li>
                        <a href="pages/archives/">Archives</a>
                    </li>
                    <li>
                        <a href="pages/category/">Category</a>
                    </li>
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script> 
        
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/assets/images/header.jpg');
    }

    header.intro-header .header-mask{
        width: 100%;
        height: 100%;
        position: absolute;
        background: rgba(0,0,0, 0.3);
    }
</style>
<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        <a class="tag" href="#" title="缓存">缓存</a>
                        <a class="tag" href="#" title="lrucache">lrucache</a>
                    </div>
                    <h1>Android内存缓存LruCache</h1>
                    <span class="meta">Posted by ivicel on 2018-04-04</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container">
                <h3 id="1-lrucahe">1. LruCahe 的使用</h3>
<p><code>LruCache</code> 类的构造方法为 <code>public LruCache(int maxSize)</code>, 其需要传入一个缓存大小, 单位为 <strong>byte</strong>, 一般我们会通过计算应用可以使用的最大内存是多少, 然后取其中的一部分作为值来传入. </p>
<blockquote>
<p>传入的内存最大值的<strong>单位</strong>要和 <code>sizeOf()</code> 返回的单位一致即可</p>
</blockquote>
<p>另然最重要的需要重写这个类的 <code>sizeOf()</code> 方法, 该方法返回值表示了每个元素的大小, 以便确定缓存是否需要删除旧的元素. 这个方法的默认实现是返回 1.</p>
<pre class="highlight"><code class="language-java linenums">// 获得应用可使用的最大内存, 取 1/8 作为缓存
final int maxSize = Runtime.getRuntime().maxMemory() / 8;
LruCache&lt;String, Bitmap&gt; bitmapCache = new LruCache&lt;&gt;(maxSize) {
    @Override
    protected int sizeOf(String key, Bitmap value) {
        // 图片缓存, 返回每个 bitmap 的大小
        // sdk 19 之后不再使用 Bitmap#getByteCount
        // Bitmap#getAllocationByteCount 可能会比 getByteCount 返回的值大
        return value.getAllocationByteCount();
    }
};</code></pre>

<p>在获得 <code>LruCache</code> 对象之后, 便可以对其进行读, 写, 删除</p>
<pre class="highlight"><code class="language-java linenums">Bitmap bitmap = bitmapCache.get(key);
// 如果缓存中已经存在, 那么旧的会被返回, 不存在则返回 null
Bitmap prevBitmap = bitmapCache.put(key, bitmap);
// 删除缓存
Btimap bitmap = bitmap.remove(key);

// 一般图片都是从网络上下载下来, 所以使用图片的 url 来作为 key 值是最好了
// 但 url 会有特殊的字符不能作为 key, 常用的方法是将 url 转为其 md5 值
public String urlToMD5(String url) {
    String key;
    try {
        final MessageDigest md = MessageDigest.getInstance("MD5");
        md.update(url.getBytes());
        key = bytesToHexString(md.digest());
    } catch (NoSuchAlgorithmException e) {
        key = String.valueOf(url.hashCode());
    }
    return key;
}

public String bytesToHexString(byte[] input) {
    // 将 byte 数组转为 16 进制字符
    StringBuilder sb = new StringBuilder();
    for (int i = 0; i &lt; input.length; i++) {
        String hex = Integer.toHexString(0xFF &amp;&amp; input[i]);
        if (hex.lenght() == 1) {
            // 只有一位时在前面补 0
            sb.append("0");
        }
        sb.append(hex);
    }

    return sb.toString();
}</code></pre>

<p>另外还可以重写 <code>entryRemove()</code> 方法, 这个方法会在<strong>元素被删除</strong>(内存不足时, remove 操作时), <strong>元素被替换</strong>(put 操作时)被调用, 默认的实现是一个空实现, 并且这个调用不是 <code>synchronization</code></p>
<pre class="highlight"><code class="language-java linenums">// @param evicted. 空间不足引起的删除时为 true. put, remove 操作引起的为 false
// @param key 元素的 key
// @param oldValue 元素的旧值
// @param newValue 元素是被替换时的新值, 被删除时该值为 null
protected void entryRemoved(boolean evicted, K key, V oldValue, V newValue);</code></pre>

<h3 id="2">2. 源码解析</h3>
<p>由于需要不断重新排序, <code>LruCache</code> 内部使用了一个 <code>LinkHashMap</code> 数据结构来存储实际内容. 这是一个<strong>双向链表</strong> 实现的 <strong>HashMap</strong>. <code>LinkHashMap</code>可以设置成<strong>基于插入顺序优先</strong>, 或者<strong>基于访问顺序优先</strong>, 把优先的元素放在链表<strong>末端</strong>, 这样链表头结点总是表示<strong>最后插入</strong>/<strong>最少访问</strong>的元素, 可以把头结点从链接中删除</p>
<pre class="highlight"><code class="language-Java linenums">public class LruCache&lt;K, V&gt; {
    public LruCache(int maxSize) {
        if (maxSize) {
            throw new IllegalArgumentException("maxSize &lt;= 0");   
        }
        this.maxSize = maxSize;
        // 第一个参数为初始容量, 第二个为 map 的负载因子, 第三个为是否基于访问顺序
        this.map = new LinkHashMap&lt;K, V&gt;(0, 0.75f, true);
    }
}</code></pre>

<p>在每次 <code>put</code>, <code>get</code> 之后, 都要使用 <code>trimToSize()</code> 来确保使用的内存容量是在规定的范围内</p>
<pre class="highlight"><code class="language-java linenums">// 传的参数是最大内存容量, 如果大于这个数, 就把头结点从链表中删除
public void trimToSize(int maxSize) {
    // 不断循环的删除头结点, 直到使用的内存小于 maxSize
    while (true) {
        K key;
        V value;
        synchronized (this) {
            // size 为当前使用的缓存容量
            if (size &lt; 0 || (map.isEmpty() &amp;&amp; size != 0)) {
                throw new IllegalStateException(getClass().getName() + 
                    ".sizeOf() is reporting inconsistent results!");
            }

            // 当现使用的容量 &lt;= 最大容量时退出循环
            if (size &lt;= maxSize) {
                break;
            }

            // LinkHashMap#eldest() 方法是 Android 实现 LinkHashMap 时添加的方法
            // 其简单的返回了链表头结点
            Map.Entry&lt;K, V&gt; toEvict = map.eldest();
            if (toEvict == null) {
                break;
            }

            // 删除头结点, 并把现使用的内存容量减小
            key = toEvict.getKey();
            value = toEvict.getValue();
            map.remove(key);
            // safeSizeOf 只是对 sizeOf 的再次封装, 其只是返回 sizeOf 并确保该值不能 &lt; 0
            size -= safeSizeOf(key, value);
            // 记录收回的元素数量
            evictionCount++;
        }

        // 调用
        entryRemoved(true, key, value, null);
    }
}</code></pre>

<p><code>LruCache#put()</code>, <code>LruCache#get()</code>方法的实现</p>
<pre class="highlight"><code class="language-java linenums">// LruCache#put()
public final V put(K key, V value) {
    if (key == null || value == null) {
        throw new NullPointerException("key == null || value == null");
    }

    // 如果添加进去的新的元素已经在内存中的话, 更新之后, 再减去旧的元素的大小
    V previous;
    synchronized (this) {
        putCount++;
        size += safeSizeOf(key, value);
        previous = map.put(key, value);
        if (previous != null) {
            size -= safeSizeOf(key, previous);
        }
    }

    if (previous != null) {
        entryRemoved(false, key, previous, value);
    }
    // 保证内存大小不超过设定
    trimToSize(maxSize);

    return previous;
}

// LruCache#get()
public final V get(K key) {
    if (key == null) {
        throw new NullPointerException("key == null");
    }

    V mapValue;
    synchronized (this) {
        // 查找链表中的元素, 如果找到了就返回该值
        mapValue = map.get(key);
        if (mapValue != null) {
            hitCount++;
            return mapValue;
        }
        missCount++;
    }

    // 如果对应值不存在的话, 调用 create() 方法尝试新建一个
    // create() 方法非线程安全, 可能会在调用的时候, 其他的线程又对该 key 进行操作
    /*
     * Attemp to create a value. This may take a long time, and the map
     * may be different when create() returns. If a conflicting value was
     * added to the map while create() was working, we leave that value in
     * the map and release the created value
     */
    V createdValue = create();
    if (createValue == null) {
        return null;
    }

    // 如果重写了 create() 并返回非 null
    // 之后我们要重新查看下缓存之中是不是有了该 key
    synchronized (this) {
        createCount++;
        mapValue = map.put(key, createdValue);;
        // 如果有了该 key 的值, 不要对其做更改
        if (mapValue != null) {
            // There was a conflict so undo that last put
            map.put(mapValue);
        } else {
            size += safeSizeOf(key, createdValue);
        }
    }

    if (mapValue != null) {
        entryRemoved(false, key, createdValue, mapValue);
        return mapValue;
    } else {
        trimeToSize(maxSize);
        return createdValue;
    }
}

// LruCache#create(), 默认返回 null
protected V create(K key) {
    return null;
}</code></pre>

<h3 id="reference">Reference:</h3>
<ol>
<li>&lt;<Android开发艺术探索>&gt;</li>
<li><a href="https://blog.csdn.net/shakespeare001/article/details/51695358">https://blog.csdn.net/shakespeare001/article/details/51695358</a></li>
</ol>

                <hr style="visibility: hidden;">
                <ul class="pager">
                </ul>
                <hr style="visibility: hidden;">

            </div>  
        </div>
    </div>
</article>


        <!-- jQuery -->
        <script src="/theme/js/jquery.min.js"></script>

        <!-- Bootstrap Core JavaScript -->
        <!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
        <script src="/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/theme/js/hux-blog.min.js"></script>

        <!-- Service Worker -->

        <!-- async load function -->
        <script>
            function async(u, c) {
                var d = document,
                    t = "script",
                    o = d.createElement(t),
                    s = d.getElementsByTagName(t)[0];
                o.src = u;
                if (c) {
                    o.addEventListener(
                        "load",
                        function(e) {
                            c(null, e);
                        },
                        false
                    );
                }
                s.parentNode.insertBefore(o, s);
            }
        </script>

        <!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
        <!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->

        <!--fastClick.js -->
        <script>
            async(
                "//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js",
                function() {
                    var $nav = document.querySelector("nav");
                    if ($nav) FastClick.attach($nav);
                }
            );
        </script>

        <!-- Google Analytics -->
        <script>
            // dynamic User by Hux
            var _gaId = "UA-113622715-2";
            var _gaDomain = "";

            // Originial
            (function(i, s, o, g, r, a, m) {
                i["GoogleAnalyticsObject"] = r;
                (i[r] =
                    i[r] ||
                    function() {
                        (i[r].q = i[r].q || []).push(arguments);
                    }),
                    (i[r].l = 1 * new Date());
                (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m);
            })(
                window,
                document,
                "script",
                "//www.google-analytics.com/analytics.js",
                "ga"
            );

            ga("create", _gaId, _gaDomain);
            ga("send", "pageview");
        </script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>
 
        
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->

                <p class="copyright text-muted">
                    Copyright &copy; Ambertime 2019                    <br>
                    Powered by <a href="">Ambertime</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=ivicel&repo=ivicel.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer> 
        

        <!-- jQuery -->
        <script src="/theme/js/jquery.min.js"></script>

        <!-- Bootstrap Core JavaScript -->
        <!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
        <script src="/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/theme/js/hux-blog.min.js"></script>

        <!-- Service Worker -->

        <!-- async load function -->
        <script>
            function async(u, c) {
                var d = document,
                    t = "script",
                    o = d.createElement(t),
                    s = d.getElementsByTagName(t)[0];
                o.src = u;
                if (c) {
                    o.addEventListener(
                        "load",
                        function(e) {
                            c(null, e);
                        },
                        false
                    );
                }
                s.parentNode.insertBefore(o, s);
            }
        </script>

        <!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
        <!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->

        <!--fastClick.js -->
        <script>
            async(
                "//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js",
                function() {
                    var $nav = document.querySelector("nav");
                    if ($nav) FastClick.attach($nav);
                }
            );
        </script>

        <!-- Google Analytics -->
        <script>
            // dynamic User by Hux
            var _gaId = "UA-113622715-2";
            var _gaDomain = "";

            // Originial
            (function(i, s, o, g, r, a, m) {
                i["GoogleAnalyticsObject"] = r;
                (i[r] =
                    i[r] ||
                    function() {
                        (i[r].q = i[r].q || []).push(arguments);
                    }),
                    (i[r].l = 1 * new Date());
                (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m);
            })(
                window,
                document,
                "script",
                "//www.google-analytics.com/analytics.js",
                "ga"
            );

            ga("create", _gaId, _gaDomain);
            ga("send", "pageview");
        </script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>
    </body>
</html>