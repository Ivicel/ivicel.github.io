<!DOCTYPE html>
<html lang="en">
    <head>
            <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="google-site-verification" content="WpfeDx8HRNQcT7jzjSsZ0vhtfw8M7gFo-YoDmXZRGHg"/>
        <meta name="google-site-verification" content="H97dWyn-QYy4n8BEw7ZAX8bFDDin_BwYiEOb3v_4dEs" />
        <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
        
  
        <title>
Ambertime        </title>

        <!-- Web App Manifest -->
        <link rel="manifest" href="https://ivicel.info/assets/pwa/manifest.json" />

        <!-- Favicon -->
        <link rel="shortcut icon" href="https://ivicel.info/assets/images/favicon.ico"/>
        <!-- Canonical URL -->
        <link rel="canonical" href="" />
        <link rel="stylesheet" href="https://ivicel.info/theme/css/bootstrap.min.css" />

        <!-- Custom CSS -->
        <link rel="stylesheet" href="https://ivicel.info/theme/css/hux-blog.min.css" />
        <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
        <link rel="stylesheet" href="https://ivicel.info/theme/css/prism.css" />
        <link rel="stylesheet" href="https://ivicel.info/theme/css/ivicel.css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
        


    <style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('https://ivicel.info/assets/images/header.jpg');
    }

    header.intro-header .header-mask{
        width: 100%;
        height: 100%;
        position: absolute;
        background: rgba(0,0,0, 0.3);
    }
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>
    </head>


    <!-- hack iOS CSS :active style -->
    <body ontouchstart="">
<!-- Navigation -->
<!-- <nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"> -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://ivicel.info/">Ambertime</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="https://ivicel.info/">Home</a>
                    </li>
                        <li>
                            <a href="https://ivicel.info/archives.html">ARCHIVES</a>
                        </li>
                        <li>
                            <a href="https://ivicel.info/about.html">ABOUT</a>
                        </li>
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script> 
        
<!-- Post Header -->

<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        <a class="tag" href="#" title="android">android</a>
                        <a class="tag" href="#" title="content provider">content provider</a>
                        <a class="tag" href="#" title="内容提供器">内容提供器</a>
                    </div>
                    <h1>Android Contnet Provider内容提供器</h1>
                    <span class="meta">Posted by ivicel on 2018-02-22</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<div class="container">
    <article>
        <div class="row">
            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container">
                <p>[TOC]</p>
<h3>1. Content Provider 的优势:</h3>
<ol>
<li>可以用来提供进程间的通信</li>
<li>提供一个统一的接口, 屏蔽了底层的具体实现. 底层可以使用数据库如<code>SQLite</code>, 文件, 或者从网络中获取</li>
<li>提供了一个<code>权限</code>限制</li>
</ol>
<h3>2. Content URI 的写法:</h3>
<blockquote>
<p><code>content://</code> + <code>AUTHORITY</code> + <code>/表名</code></p>
<p><code>content://com.example.myapp.provider/table1</code></p>
<p><code>AUTHORITY</code>一般默认写成<code>包名.provider</code>, <code>包名.provider类名</code>, 一般用包名在前修饰, 以免在需要共享给别的程度时产生冲突</p>
<p>后面跟表名, 或者还可以跟修饰符<code>*</code>, <code>#</code>, </p>
</blockquote>
<p>书写规则</p>
<p><code>*</code>表示匹配任意长度任意字符</p>
<blockquote>
<p><code>content://com.example.myapp.provider/*</code> 查询所有表中所有数据</p>
</blockquote>
<p><code>#</code>表示匹配任意长度的数字</p>
<blockquote>
<p><code>content://com.example.myapp.provider/table1/#</code> </p>
<p>查询<code>table1</code>中的某一行, 如果提供了这类<code>MIME_TYPE</code>的话, 可以使用</p>
<p><code>content://com.example.myapp.provider/table/3</code>访问表<code>table</code>的第<code>3</code>行数据</p>
<p>此时可以使用类<code>ContentUris</code>添加一个<code>id</code>, 类<code>Uri#withAppendedPath</code>也是一样, 只不过接收的是一个<code>String</code>类型</p>
<p><code>Uri singleUri = ContentUris.withAppendedId(MyProvider.CONTENT_URI, id)</code></p>
</blockquote>
<h4><code>MIME</code>的写法</h4>
<hr />
<blockquote>
<ol>
<li>必须以<code>vnd</code>开头</li>
<li>如果以内容URI结尾的, 后面接<code>android.cursor.item/</code>; 如果以目录URI结尾的, 后面接<code>android.cursor.dir/</code></li>
<li>最后接上<code>vnd.&lt;authority&gt;.&lt;path&gt;</code> </li>
</ol>
</blockquote>
<p>例如: <code>vnd.android.cursor.dir/vnd.com.example.myapp.provider/table1</code></p>
<p><code>ContentResolver</code>类中有两个预定义的<code>vendor</code></p>
<p><code>ContentResolver.CURSOR_ITEM_BASE_TYPE = "vnd.android.cursor.item"</code></p>
<p><code>ContentResolver.CURSOR_DIR_BASE_TYPE = "vnd.android.cursor.dir"</code></p>
<h4>在<code>AndroidManifest.xml</code>中写法</h4>
<hr />
<p>当非同一个程序中需要使用<code>Content Provider</code>时, 必须要在<code>AndroidManifest.xml</code>声明使用权限. 比如读写用户字典:<code>&lt;use-permission name="android.permission.READ_USER_DICTIONARY&gt;</code></p>
<p>然而如果在同一程序中, 无论是否声明自定义权限, 原程序都有其读写的权限</p>
<pre class="highlight line-numbers"><code class="language-xml linenums">&lt;provider
          android:authorities="list" // 要和类中定义的认证名完全一样
          android:directBootAware=["true" | "false"] // unlock deivce之前进行启动privoder
          andorid:enabled=["true" | "false"] // 启用
          android:exported=["true" | "false"] // 外部是否可访问到
          android:grantUriPermissions=["true" | "false"] // 可授予特定的uri临时权限. 如果true, 则可以授予权限给任意uri. false则只能授予权限给特定uri. 默认false
// 特定的uri权限在&lt;grant-uri-permission&gt;中声明
          android:icon="drawable resource" // 设置一个调用时的图标, 默认是application icon
          android:initOrder="integer" // 同一进程中的content provider初始顺序, 默认是从大的数字先初始
          android:label="string resource" // 默认使用application label
          android:multiprocess=["true" | "false"] // 在程序使用多进程情况下, true表示各进程生成各自的content provider object. false表示共用. 默认false
          android:name="string" // provider的名称. 一般取作 package.UserDictionaryProvider, 后面是provider的用处
          android:permission="string" // 设置一个读写权限名
          android:readPermission="string" // 读权限, 覆盖掉 android:permission 如果有
          android:wirtePermission="string" // 写权限, 覆盖掉 android:permission 如果有
          andorid:process="string" // 进程的名称. 用来表示需要哪个进程来运行这个content provider                           // 一般情况下所有的 application components 都运行在同一进程下                         // components 都有自己的 process 属性来表示需要运行在不同的进程当中                    // 如果以一个分号(:)开头的进程名, 表示运行在一个程序私有新进程中                         // 如果直接以名字, 则表示运行在一个全局共享可访问的进程中
          android:syncable=["true" | "false"]&gt; // 表示 content provider 底层数据是否是 synchronized

  // 在&lt;provider&gt;标签中还能包含&lt;meta-data&gt;, &lt;grant-uri-permission&gt;, &lt;path-permission&gt;标签
  // path-level permission中定义的权限会覆盖掉 application-level 中&lt;permission&gt;定义和provider-level 中的权限
  // 而 grant-uri-permission是对临时uri的权限, 不受这三个level的影响
  // 总体下说, 下层的权限覆盖总是对上层权限更加的精确把控, 需要精确分层时使用

&lt;/provider&gt;

&lt;provider android:name=".MyProvider"
          android:authorities="com.example.myapp.MyProvider"
          android:enable="true"
          android:exported="false"/&gt;

</code></pre>

<h4>创建一个自定义的<code>Content Provider</code></h4>
<p>--------------------------------------;</p>
<ol>
<li>自定义一个类继承<code>ContentProvider</code>, 实现<code>onCreate</code>, <code>query</code>, <code>insert</code>, <code>update</code>, <code>delete</code>, <code>getType</code>方法</li>
<li>使用<code>UriMatcher</code>类快速生成或者匹配<code>uri</code></li>
</ol>
<pre class="highlight line-numbers"><code class="language-java linenums">
public class MyProvider extends ContentProvider {

    public static final String AUTHORITY = "com.example.myapp.MyProvider";
    private static UriMatcher sUriMatcher;

    private static final int SEARCH_WORDS = 0;
    private static final int GET_WORD_DEFINITION = 1;
    private static final int SEARCH_SUGGEST = 2;

    public static final String WORD_MIME_TYPE = 
        ContentResolver.CURSOR_DIR_BASE_TYPE + 
        "/vnd.com.example.myapp.dictionary";
    public static final String DEFINITION_MIME_TYPE = 
        ContentResolver.CURSOR_ITEM_BASE_TYPE +
        "/vnd.com.example.myapp.dictionary";
    public static final String SEARCH_SUGGEST_MIME_TYPE = 
        ContentResolver.CURSOR_DIR_BASE_TYPE +
        "vnd.com.example.myapp.search_suggest";

    // 生成匹配的对应 uri 的 mime type
    static {
        sUriMatcher = new UriMatcher(UriMatcher.NO_MATCH);
        // search words
        sUriMatcher.addURI(AUTHORITY, "dictionary", SEARCH_WORDS);
        sUriMatcher.addURI(AUTHORITY, "dictionary/#", GET_WORD_DEFINITION);
        sUriMatcher.addURI(AUTHORITY, "search_suggest", SEARCH_SUGGEST);
    }

    @Override
    public boolean onCreate() {
        // 在第一次调用ContentResolver访问时会调用该方法
        // 返回true表示创建成功
        return true;
    }

    @Nullable
    @Override
    public Cursor query(@NonNull Uri uri, @Nullable String[] projection,
            @Nullable String selection,
            @Nullable String[] selectionArgs, @Nullable String sortOrder) {
        return null;
    }

    @Nullable
    @Override
    public String getType(@NonNull Uri uri) {
        switch (sUriMatcher.match(uri)) {
            case SEARCH_WORDS:   
                return WORD_MIME_TYPE;
            case GET_WORD:
                return DEFINITION_MIME_TYPE;
            case SEARCH_SUGGEST:
                return SEARCH_SUGGEST_MIME_TYPE;
            default:
                throw new IllegalArgumentException("Unknown URL: " + uri);
        }
    }

    @Nullable
    @Override
    public Uri insert(@NonNull Uri uri, @Nullable ContentValues values) {
        // insert to database/file
        // return new rows uri
        return null;
    }

    @Override
    public int delete(@NonNull Uri uri, @Nullable String selection,
            @Nullable String[] selectionArgs) {
        // delete datas
        // return how many rows were deleted
        return 0;
    }

    @Override
    public int update(@NonNull Uri uri, @Nullable ContentValues values,
            @Nullable String selection,
            @Nullable String[] selectionArgs) {
        // update something
        // return how many 
        return 0;
    }
}
</code></pre>

<h4>除了使用<code>ContentResolver</code>外, 其他几种访问<code>Content Provider</code>方法</h4>
<hr />
<ul>
<li><code>Batch access</code></li>
</ul>
<p>提供了一种批量处理方法, 首先生成一个<code>ArrayList&lt;ContentProviderOperation&gt;</code>数组, 向数组中添加所需操作, 然后使用<code>ContentResolver.applyBatch(ArrayList)</code>来调用这个批处理事件. 这会使<code>ContentResolver</code>调用<code>ContentProvider#applyBatch</code>方法, 可以在自定义<code>ContentProvider</code>时覆写这个方法, 其原始方法只是调用了<code>ContentProviderOperation#apply()</code>方法</p>
<p>在<strong>Google Sample</strong>中 [Contact Manager][!<a href="https://android.googlesource.com/platform/development/+/master/samples/ContactManager/">https://android.googlesource.com/platform/development/+/master/samples/ContactManager/</a>] 示例中文件 [<code>ContacAdder.java</code>][!<a href="https://android.googlesource.com/platform/development/+/master/samples/ContactManager/src/com/example/android/contactmanager/ContactAdder.java">https://android.googlesource.com/platform/development/+/master/samples/ContactManager/src/com/example/android/contactmanager/ContactAdder.java</a>] 演示批处理的用法</p>
<ul>
<li><code>Loader</code></li>
</ul>
<p>因为 <code>SimpleCursorAdapter</code>的弃用, 现在使用<code>Loader</code>来异步加载数据, 其能根据 <code>Activity</code> <code>Fragment</code> 的生命周期来控制数据获取周期, 以免造成<strong>ANR</strong>, 或者是重复加载数据</p>
<ul>
<li><code>Data access via intents</code></li>
</ul>
<p>使用<code>Intent</code>可以间接的访问到你没有获得权限的<code>Content Provier</code>.</p>
<blockquote>
<p>需要在<code>AndroidManifest.xml</code>中的<code>&lt;provider&gt;</code>提供<code>android:grantUriPermission="true"</code></p>
<p>或者<code>&lt;grant-uri-permission&gt;</code>中提供的可授权许可</p>
</blockquote>
<p>比如在<code>MyApp</code>中提供调用相机程序的拍照功能 , 在<code>MyApp</code>中自定义一个<code>FileProvider</code>来提供路径地址来存储获得的照片(<code>Internal Storage</code>或<code>External Storage</code>), 然而由于访问程序私有路径是非法的, 需要获得相应的授权. </p>
<p>此时我们就可以在调用相应的<code>Intent</code>时, 使用<code>Context#grantUriPermission()</code>加上<code>Content.FLAG_GRANT_READ_URI_PERMISSION</code>或是<code>Content.FLAG_GRANT_WRITE_URI_PERMISSION</code>授予该<code>uri</code>(仅仅是针对该<strong>URI</strong>, 并不是整个<code>Content Provider</code>)临时权限, 在调用的<code>Intent</code>返回结束, 为保证安全, 调用 <code>Context#revokeUriPermission()</code>来取消掉这个权限.</p>
<blockquote>
<p>Tips: <code>FileProvider</code>在4.4以上会自动授权</p>
</blockquote>
<p>又例如, 即使没有声明<code>Manifest.permission.READ_CONTACTS</code>, 也可以使用一个<code>Intent.ACTION_PICK</code>来挑选个联系人加上<code>ContactsContrac.RawContacts.CONTENT_ITEM_TYPE</code>这个<code>uri</code>来获取一个联系人信息. 由于这些操作是在前台<code>UI</code>上执行的, 用户可以看到并且选择联系人是自己操作的, 相当用户同意授予了其读取联系人的权限</p>
<h4><code>Contract Classses</code></h4>
<hr />
<p>所谓<code>Contract Classes</code>是一些定义了一些<code>constants</code>, <code>content URIs</code>, <code>column names</code>, <code>intent actions</code></p>
<p>例如<code>UserDictionary.Words.CONTENT_URI</code>, <code>UserDictionary.Words</code>, <code>ContactsContract</code></p>

                <hr style="visibility: hidden;">
                <ul class="pager">
                </ul>
                <hr style="visibility: hidden;">


                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
            </div>  
            <div class="col-lg-2 col-lg-offset-0 visible-lg-block sidebar-container catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        </div>
    </article>
</div>

 
        
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->

                <p class="copyright text-muted">
                    Copyright &copy; Ambertime 2019                    <br>
                    Powered by <a href="http://getpelican.com/">Pelican</a> | Theme by <a href="http://huangxuan.me">HuxPro</a>
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=ivicel&repo=ivicel.github.io&type=star&count=true" >
                    </iframe>
                    
                </p>
            </div>
        </div>
    </div>
</footer> 
        
        <script src="https://ivicel.info/theme/js/jquery.min.js"></script>
        <script src="https://ivicel.info/theme/js/bootstrap.min.js"></script>
        <script src="https://ivicel.info/theme/js/animatescroll.min.js"></script>
        <script src="https://ivicel.info/theme/js/prism.js"></script>
        <script src="https://ivicel.info/theme/js/hux-blog.min.js"></script>
        <script src="https://ivicel.info/theme/js/snackbar.js"></script>
        <!--fastClick.js -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                TeX: {
                equationNumbers: {
                    autoNumber: "AMS"
                }
                },
                tex2jax: {
                inlineMath: [ ['$','$'] ],
                displayMath: [ ['$$','$$'] ],
                processEscapes: true,
                }
            });
            </script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        <!-- Google Analytics -->
        <script>
            var _gaId = "UA-113622715-2";
            var _gaDomain = "https://ivicel.info";

            // Originial
            (function(i, s, o, g, r, a, m) {
                i["GoogleAnalyticsObject"] = r;
                (i[r] =
                    i[r] ||
                    function() {
                        (i[r].q = i[r].q || []).push(arguments);
                    }),
                    (i[r].l = 1 * new Date());
                (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m);
            })(
                window,
                document,
                "script",
                "//www.google-analytics.com/analytics.js",
                "ga"
            );

            ga("create", _gaId, _gaDomain);
            ga("send", "pageview");
        </script>

        <!-- Side Catalog -->

<script type="text/javascript">
    

</script>


<script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js"></script>
<script src="https://ivicel.info/theme/js/jquery.nav.js"></script>

<script type="text/javascript">
    anchors.options = {
        visible: 'always',
        placement: 'right',
        icon: '#'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }));
    
    var disqus_config = function () {
        this.page.url = 'https://ivicel.info/2018/02/android-contnet-providernei-rong-ti-gong-qi.html';
        this.page.identifier = 'Android Contnet Provider内容提供器';
        this.page.title = 'Android Contnet Provider内容提供器';
    };

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//ambertime.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </body>
</html>