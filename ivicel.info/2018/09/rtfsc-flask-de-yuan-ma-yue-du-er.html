<!DOCTYPE html>
<html lang="en">
    <head>
            <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="google-site-verification" content="WpfeDx8HRNQcT7jzjSsZ0vhtfw8M7gFo-YoDmXZRGHg"/>
        <meta name="google-site-verification" content="H97dWyn-QYy4n8BEw7ZAX8bFDDin_BwYiEOb3v_4dEs" />
        <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  
        <title>
Ambertime        </title>

        <!-- Web App Manifest -->
        <link rel="manifest" href="/assets/pwa/manifest.json" />

        <!-- Favicon -->
        <link rel="shortcut icon" href="/assets/images/favicon.ico"/>
        <!-- Canonical URL -->
        <link rel="canonical" href="" />
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" />

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/theme/css/hux-blog.min.css" />
        <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
        <link rel="stylesheet" href="/theme/css/prism.css" />
        <link rel="stylesheet" href="/theme/css/ivicel.css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
        


    <style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/assets/images/header.jpg');
    }

    header.intro-header .header-mask{
        width: 100%;
        height: 100%;
        position: absolute;
        background: rgba(0,0,0, 0.3);
    }
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>
    </head>


    <!-- hack iOS CSS :active style -->
    <body ontouchstart="">
<!-- Navigation -->
<!-- <nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"> -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Ambertime</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                        <li>
                            <a href="/archives">ARCHIVES</a>
                        </li>
                        <li>
                            <a href="/about">ABOUT</a>
                        </li>
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script> 
        
<!-- Post Header -->

<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        <a class="tag" href="#" title="flask">flask</a>
                        <a class="tag" href="#" title="python">python</a>
                        <a class="tag" href="#" title="源代码阅读">源代码阅读</a>
                        <a class="tag" href="#" title="RTFSC">RTFSC</a>
                    </div>
                    <h1>RTFSC: Flask 的源码阅读(二)</h1>
                    <span class="meta">Posted by ivicel on 2018-09-18</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<div class="container">
    <article>
        <div class="row">
            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container">
                <h4>1. 路由派发</h4>
<p>由 <code>Flask.full_dispatch_request()</code> 发起路由派发</p>
<pre class="highlight line-numbers"><code class="language-python linenums">def full_dispatch_request(self):
    # before_first_request 的回调
    self.try_trigger_before_first_request_functions()
    try:
        # signal 注册的回调
        request_started.send(self)
        # before_request 的回调, 在这我们也可以看到
        # 只有 before_request 回调中返回 None, 才继续向下派发
        rv = self.preprocess_request()
        if rv is None:
            rv = self.dispatch_request()
    except Exception as e:
        rv = self.handle_user_exception(e)
    return self.finalize_request(rv)</code></pre>

<ul>
<li>回调程序运行后, 第一次有 request 到达时的注册方法</li>
</ul>
<p>在 <code>Flask.try_trigger_before_first_request_functions()</code> 运行我们在程序中使用 <code>before_first_request()</code> 注册的回调, 这是在程序运行时接收到第一次请求时调用, 可以注册多个回调方法, 检测第一次 request 只是使用了一个简单的标志位 <code>_got_first_request</code>.</p>
<p><strong>需要注意的是</strong></p>
<ol>
<li>回调这些方法的时, 使用了线程锁 <code>_before_request_lock</code> 在保证方法总是在回调用 reqeust 之前被调用, 想像一下多线程版本时, 可以同时到达多个 request. </li>
<li>在取得锁之后, 我们还在再次检查 <code>_got_first_request</code> 标志, 确保这些回调只调用过一次</li>
</ol>
<pre class="highlight line-numbers"><code class="language-python linenums">with self._before_request_lock:
    if self._got_first_request:
        return
    # before_first_request_funcs 是注册的方法列表
    for func in self.before_first_request_funcs:
        func()
    self._got_first_request = True</code></pre>

<ul>
<li>
<p>如果我们安装了 <code>blinker</code> , 这是一个同步的事件派发器, flask 为我们注册了一些事件, 像 <code>request-started</code>, <code>request-finished</code>, 以便我们在可以在程序外监听, 如果我们没有安装 <code>blinker</code>, 不会触发这些事件. 事件在 <code>flask.signals</code> 中</p>
</li>
<li>
<p>下来便是由 <code>url_value_request</code> 注册的回调和由 <code>before_request</code> 注册的回调. 前者是的回调方法里接收两个参数, 一是 <code>reqeust.endpoint</code> 这个默认就是方法的 <code>__name__</code>, 二是  <code>request.view_args</code> 这个是请求的参数 <code>query_string</code>.  前者回调存放在 <code>Flask.url_value_preprocessor</code>, 后者在 <code>Flask.before_request_func</code></p>
</li>
</ul>
<p>这里需要注意的是我们有两个地方可以注册该事件, 一是全局 <code>Flask</code>, 二是 <code>Blueprint</code>. 这两种回调方法都存放在同一个变量中. 这是一个 dict, 全局的注册 <code>key</code> 为 <code>None</code>, 对 <code>Blueprint</code> 则是 blueprint 的名称为 <code>key</code>.</p>
<blockquote>
<p>对象 <code>before_request</code> , 当其中有方法返回非 <code>None</code> 时, 该 request 便返回给客户端了</p>
</blockquote>
<ul>
<li>下来派发到我们注册的路由方法</li>
</ul>
<pre class="highlight line-numbers"><code class="language-python linenums">def dispatch_request(self):
    # Request 是从 werkzeug.wrapper.Reqeust 继承来的
    # 前面讲过, 当有 exception 时, exception 保存在 Request.routing_exception 中
    req = _request_ctx_stack.top.request
    if req.routing_exception is not None:
        # 抛出异常或者抛出调试异常
        self.raise_routing_exception(req)
  # 没有问题
    rule = req.url_rule
  # 我们在注册 view_func 时, 可以提供一个 provide_automatic_options 参数
    # 当这个为 True, 并且是 OPTIONS 请求时, 直接回复一个默认 option_response
    if getattr(rule, 'provide_automatic_options', False) \
       and req.method == 'OPTIONS':
        return self.make_default_options_response()
    # 终于来到我们自己注册的路由方法
    return self.view_functions[rule.endpoint](**req.view_args)

def raise_routing_exception(self, request):
    # 非 debug 模式, 或者非重定向, 或是 (GET, HEAD, OPTIONS) 之一中的请求
    # 直接抛出
    if not self.debug \
       or not isinstance(request.routing_exception, RequestRedirect) \
       or request.method in ('GET', 'HEAD', 'OPTIONS'):
        raise request.routing_exception
  # 在 debug 模式下, 抛出不同的输出, 也就是我们调试时看到调试页面
    from .debughelpers import FormDataRoutingRedirect
    raise FormDataRoutingRedirect(request)
</code></pre>

<h4>2. 请求异常处理</h4>
<p>如果在请求处理是发生异常, 会抛到 <code>full_dispatch_request()</code> 中, 在 <code>handle_user_exception()</code> 中处理</p>
<pre class="highlight line-numbers"><code class="language-python linenums">def handle_user_exception(self, e):
    # 确保当前系统中刚发生的异常是原先我们捕捉到的异常
    # 如果不是的话, 那么向上 wsgi_app 中抛出 AssertionError
    # 由 handle_exception() 来处理
    exc_type, exc_value, tb = sys.exc_info()
    assert exc_value is e
    # BadRequestKeyError 指的是比如请求时需要提供某个参数, 但没有提供
    # 像 form 中 csrf_token, 那么会产生一个 KeyError, 而客户端则会收到一个 400 Bad Request
    if (
        (self.debug or self.config['TRAP_BAD_REQUEST_ERRORS'])
        and isinstance(e, BadRequestKeyError)
        # only set it if it's still the default description
        and e.description is BadRequestKeyError.description
    ):
        e.description = "KeyError: '{0}'".format(*e.args)
    # trap_http_exception 受到配置 'TRAP_HTTP_EXCEPTIONS', 这个会使用所有 exception 
    # 返回 True. 配置 'TRAP_BAD_REQUEST_ERRORS' 会单独捕捉 BAD_REQUEST
    if isinstance(e, HTTPException) and not self.trap_http_exception(e):
        # 默认的 http exception 处理.
        # 先查找注册的 error handler, 没有的话直接返回 exception 对象
        return self.handle_http_exception(e)
    # 查找注册了 error handler, 没有话重新抛出, 回到 handle_exception 处理
    handler = self._find_error_handler(e)
    if handler is None:
        reraise(exc_type, exc_value, tb)
    # handler() 要求返回的是一个 response
    return handler(e)

 def handle_exception(self, e):
    """默认的 exception 处理方法, 非 debug 模式下, 返回 500 Internal Server Error
       并记录到日志文件中
    """
    exc_type, exc_value, tb = sys.exc_info()
    # blinker 事件派发
    got_request_exception.send(self, exception=e)
    # 查找注册的 HTTP 状态处理方法, 404 500, 403 之类
    handler = self._find_error_handler(InternalServerError())
    # 查找配置文件 app.config 中 PROPAGATE_EXCEPTIONS, 向上抛出异常
    if self.propagate_exceptions:
        if exc_value is e:
            reraise(exc_type, exc_value, tb)
        else:
            raise e

    self.log_exception((exc_type, exc_value, tb))
    if handler is None:
        # 默认的 500
        return InternalServerError()
    # 使用我们自己的 500 处理方法
    return self.finalize_request(handler(e), from_error_handler=True)   </code></pre>

<h4>3. 结束派发</h4>
<p>如果我们在 <code>handle_user_exception</code> 不向上抛出异常, 将会运行到 <code>finalize_request()</code></p>
<pre class="highlight line-numbers"><code class="language-python linenums">def finalize_request(self, rv, from_error_handler=False):
    # 从 view_func 获得的正常 resepon 
    # 或者由捕获异常后, 生成的 404, 400, 500 之类的 response 对象
    response = self.make_response(rv)
    try:
        # 处理 after_request 注册的方法, 和 before_request 相同
        # 处理 session 相关, 把 session 发送到客户端
        response = self.process_response(response)
        # blinker 注册的事件
        request_finished.send(self, response=response)
    except Exception:
        # 从 handle_exception 过来的就是 True
        # # 从 handle_user_exception 过来就是 False, 那么就会抛到调用 Flask 应用的程序中
        if not from_error_handler:
            raise
        self.logger.exception('Request finalizing failed with an '
                              'error while handling an error')
    return response</code></pre>

<p>返回到 <code>Flask.wsgi_app</code> 中, 然后依设置来决定是否弹出 <code>RequestContext</code></p>
<pre class="highlight line-numbers"><code class="language-python linenums">def auto_pop(self, exc):
    # 通过设置 flask._preserve_context 来保留 context
    # 出错了, 并且通过配置文件设置了 PRESERVE_CONTEXT_ON_EXCEPTION
    # 这个会下次 push 的时候被弹出
    if self.request.environ.get('flask._preserve_context') or \
       (exc is not None and self.app.preserve_context_on_exception):
        self.preserved = True
        self._preserved_exc = exc
    else:
        # 弹出 RequestContext 才会回调 teardown_request
        self.pop(exc)

def pop(self, exc=_sentinel):
    # 非保留情况下, 会每次新创建一个 AppContext 压入 _implicit_app_ctx_stack
    app_ctx = self._implicit_app_ctx_stack.pop()

    try:
        clear_request = False
        # 一般情况下 _implicit_app_ctx_stack 只有一个 AppContext, 上面已经弹出
        if not self._implicit_app_ctx_stack:
            self.preserved = False
            self._preserved_exc = None
            if exc is _sentinel:
                exc = sys.exc_info()[1]
            # app 级别的 teardown_request
            self.app.do_teardown_request(exc)
            if hasattr(sys, 'exc_clear'):
                sys.exc_clear()

            request_close = getattr(self.request, 'close', None)
            if request_close is not None:
                request_close()
            clear_request = True
    finally:
        rv = _request_ctx_stack.pop()

        # get rid of circular dependencies at the end of the request
        # so that we don't require the GC to be active.
        if clear_request:
            rv.request.environ['werkzeug.request'] = None

        # Get rid of the app as well if necessary.
        if app_ctx is not None:
            app_ctx.pop(exc)

        assert rv is self, 'Popped wrong request context.  ' \
            '(%r instead of %r)' % (rv, self)
</code></pre>

<p>如果在不保留 RequestContext 的话, 每次请求都会弹出 ReqeustContext 和 AppContext, 所以这也说明了如果我们在请求处理方法之外使用 RequestContext 或 AppContext 的话, 就会发生 Working outside of request context 这种情况.</p>
<h4>3. <code>request</code>, <code>current_app</code>, <code>g</code>, <code>session</code> 全局代理</h4>
<p>从由 <code>_app_ctx_stack</code> 获得的,  这两个代理, 特别是 <code>g</code> 代理, 一般我们把一个全局的东西</p>
<ul>
<li><code>current_app</code> 指向是当前的 <code>flask.app.Flask</code> 对象</li>
<li><code>g</code> 指向的是当前的 <code>flask.app.Flask</code> 对象 <code>g</code> 字典, 一般用来</li>
</ul>
<p>当使用 <code>with Flask.app_context()</code> 的时候, 在 <code>with</code> 语句内 <code>current_app</code> 便会指向当前的 <code>Flask</code> 对象.  我们也知道在请求到来的时候, <code>RequestContext.push()</code> 也会把 <code>AppContext</code> 压入栈中, 此时 <code>current_app</code> 也是可以使用的. <code>g</code> 对象则是 <code>AppContext</code> 中的一个</p>
<pre class="highlight line-numbers"><code class="language-python linenums">current_app = LocalProxy(_find_app)
g = LocalProxy(_partial(_loopku_app_object, 'g'))</code></pre>

<p>从由 <code>_request_ctx_stack</code> 获得的</p>
<ul>
<li>
<p><code>request</code> 指向是当前请求 <code>flask.wrappers.Request</code> 对象</p>
</li>
<li>
<p><code>session</code> 指向是当前的 session, <code>flask.sessions.SecureCookieSession</code> 对象</p>
</li>
</ul>
<pre class="highlight line-numbers"><code class="language-python linenums"># 这两个都是代理对象, 经过 RequestContext 中取得其内部的值
request = LocalProxy(partial(_lookup_req_object, 'request'))
session = LocalProxy(partial(_lookup_req_object, 'session'))</code></pre>

<p>在 <code>_lookup_xx_object</code> 中都是调用对应的 <code>_ctx_xx_stack.top</code>, 这里检查了 <code>top</code> 是否存在, 不存在的话抛出 <code>RuntimeError</code></p>
<pre class="highlight line-numbers"><code class="language-python linenums">class LocalProxy(object):
    """代理类的源码, 主要是 __getattr__, __getitem__, __setitem__ 这些对应到内部的
       真正的对象
    """
    __slots__ = ('__local', '__dict__', '__name__', '__wrapped__')

    # self.__local 便是我们传入的查找函数
    def __init__(self, local, name=None):
        object.__setattr__(self, '_LocalProxy__local', local)
        object.__setattr__(self, '__name__', name)
        if callable(local) and not hasattr(local, '__release_local__'):
            object.__setattr__(self, '__wrapped__', local)

    def _get_current_object(self):
        # 返回了对应的 _lookup_*_object, 也就是对应的 RequestContext, 或 AppContext
        if not hasattr(self.__local, '__release_local__'):
            return self.__local()
        try:
            return getattr(self.__local, self.__name)
        except AttributeError:
            raise RuntimeError('no object bound to %s' % self.__name)

    # 我们在使用 request.args 这样的方法时, 其实就是 
    # RequestContext['request'][name]
    # 这样就回到了 _request_ctx_stack.request[name] 了
    def __getattr__(self, name):
        if name == '__members__':
            return dir(self._get_current_object())
        return getattr(self._get_current_object(), name)

    def __setitem__(self, key, value):
        self._get_current_object()[key] = value</code></pre>

<p>所以这也说明了为什么当 outside context, <code>current_app</code>, <code>request</code>, <code>session</code>, <code>g</code> 这些代理都是不可用的, 这些代理都是去 <code>_request_ctx_stack</code> 或 <code>_app_ctx_stack</code> 查找对应的值. 当我们使用 <code>with flaks_app.app_context()</code> 的时候, 会帮我们压入一个 <code>AppContext</code> 来使用, 并帮我们管理上下文. </p>

                <hr style="visibility: hidden;">
                <ul class="pager">
                </ul>
                <hr style="visibility: hidden;">

            </div>  
        </div>
    </article>
</div>

        <script src="/theme/js/jquery.min.js"></script>
        <script src="/theme/js/bootstrap.min.js"></script>
        <script src="/theme/js/prism.js"></script>
        <script src="/theme/js/hux-blog.min.js"></script>
        <script src="/theme/js/snackbar.js"></script>
        <script src="/theme/js/sw-registration.js"></script>
        <!--fastClick.js -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>

        <!-- Google Analytics -->
        <script>
            var _gaId = "UA-113622715-2";
            var _gaDomain = "";

            // Originial
            (function(i, s, o, g, r, a, m) {
                i["GoogleAnalyticsObject"] = r;
                (i[r] =
                    i[r] ||
                    function() {
                        (i[r].q = i[r].q || []).push(arguments);
                    }),
                    (i[r].l = 1 * new Date());
                (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m);
            })(
                window,
                document,
                "script",
                "//www.google-analytics.com/analytics.js",
                "ga"
            );

            ga("create", _gaId, _gaDomain);
            ga("send", "pageview");
        </script>


<script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js"></script>
 
        
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->

                <p class="copyright text-muted">
                    Copyright &copy; Ambertime 2019                    <br>
                    Powered by <a href="http://getpelican.com/">Pelican</a> | Theme by <a href="http://huangxuan.me">HuxPro</a>
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=ivicel&repo=ivicel.github.io&type=star&count=true" >
                    </iframe>
                    
                </p>
            </div>
        </div>
    </div>
</footer> 
        
        <script src="/theme/js/jquery.min.js"></script>
        <script src="/theme/js/bootstrap.min.js"></script>
        <script src="/theme/js/prism.js"></script>
        <script src="/theme/js/hux-blog.min.js"></script>
        <script src="/theme/js/snackbar.js"></script>
        <script src="/theme/js/sw-registration.js"></script>
        <!--fastClick.js -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>

        <!-- Google Analytics -->
        <script>
            var _gaId = "UA-113622715-2";
            var _gaDomain = "";

            // Originial
            (function(i, s, o, g, r, a, m) {
                i["GoogleAnalyticsObject"] = r;
                (i[r] =
                    i[r] ||
                    function() {
                        (i[r].q = i[r].q || []).push(arguments);
                    }),
                    (i[r].l = 1 * new Date());
                (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m);
            })(
                window,
                document,
                "script",
                "//www.google-analytics.com/analytics.js",
                "ga"
            );

            ga("create", _gaId, _gaDomain);
            ga("send", "pageview");
        </script>


<script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js"></script>
    </body>
</html>