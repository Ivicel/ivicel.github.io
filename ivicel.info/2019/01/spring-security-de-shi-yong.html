<!DOCTYPE html>
<html lang="en">
    <head>
            <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  
        <title>
Ambertime        </title>

        <!-- Web App Manifest -->
        <link rel="manifest" href="/assets/pwa/manifest.json" />

        <!-- Favicon -->
        <link rel="shortcut icon" href="/assets/images/favicon.ico"/>
        <!-- Canonical URL -->
        <link rel="canonical" href="" />
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" />

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/theme/css/hux-blog.min.css" />
        <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
        <link rel="stylesheet" href="/theme/css/prism.css" />
        <link rel="stylesheet" href="/theme/css/ivicel.css" />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
        


    <style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/assets/images/header.jpg');
    }

    header.intro-header .header-mask{
        width: 100%;
        height: 100%;
        position: absolute;
        background: rgba(0,0,0, 0.3);
    }
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>
    </head>


    <!-- hack iOS CSS :active style -->
    <body ontouchstart="">
<!-- Navigation -->
<!-- <nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"> -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Ambertime</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                        <li>
                            <a href="/archives">ARCHIVES</a>
                        </li>
                        <li>
                            <a href="/about">ABOUT</a>
                        </li>
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script> 
        
<!-- Post Header -->

<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        <a class="tag" href="#" title="spring">spring</a>
                        <a class="tag" href="#" title="spring security">spring security</a>
                    </div>
                    <h1>Spring Security 的使用</h1>
                    <span class="meta">Posted by ivicel on 2019-01-03</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<div class="container">
    <article>
        <div class="row">
            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container">
                <h4>1. Spring Security 的开启方式</h4>
<p>在 Java Web 中一般使用 Filter 来对请求进行拦截, Spring Security 基于此来对在进入 DispatcherServlet 前对 Spring MVC 进行请求拦截, 进行统一难, 从而决定是否放行</p>
<ul>
<li>如果使用 <code>web.xml</code> 进行配置, Spring Security 提供了一个 <code>DelegatingFilterProxy</code> 的 Filter 代理器, 只要在 <code>web.xml</code> 中配置该 Filter</li>
<li>如果使用注解方式, 则在配置中加入 <code>@EnableWebSecurity</code>, 该注解会自动生成一个 <code>SecurityFilterChain</code> 的 Spring Bean, 该 Bean 包含一个 Filter List, 所有的请求都会由 DelegatingFilterProxy 派发到 Filter List 中</li>
<li>如果使用的是 Spring Boot, 在添加 spring-boot-starter-security 依赖后, 根据 srping boot 的自动配置机制, 会对所有的路由进行 security 拦截, 其实际启用了 <code>@EnableWebSecurity</code>. 如果手动启用该配置, 那么会覆盖自动配置设置</li>
</ul>
<p>启用 spring security 之后, 默认会对所有的路由路径进行认证, 默认的用户名为 user, 默认的密码会在每次启动程序时随机生成, 打印在 INFO 日志中. Spring Boot 在 <code>application.properties</code> 中有 <code>spring.security.*</code> 配置可以设置简单的配置项</p>
<p>一般我们都会使用继承 <code>WebSecurityConfigurerAdapter</code> 来自定义更加复杂精确的过滤, 主要实现其中 3 个方法</p>
<ul>
<li><code>configure(AuthenticationManagerBuilder auth)</code> 用来配置用户签名, 主要是 user-details 机制, 给予用户赋予用户名, 密码, 角色, 加载用户权限</li>
<li><code>configure(HttpSecurity http)</code> 用来配置拦截保护请求, 决定哪些请求放行, 哪些请求需要验证</li>
<li><code>configure(WebSecurity web)</code> 用来配置 Filter 链</li>
</ul>
<h4>2. 验证用户(用户名, 密码, 角色...)</h4>
<h5>2.1 使用内存签名</h5>
<p>在 Spring 5 之后要求使用一个密码编码器, 用来对密码进行加密以及密码匹配, 其要实现接口 <code>PasswordEncoder</code>, 以使用内存签名服务为例</p>
<pre class="highlight line-numbers"><code class="language-java linenums">@Override
protected void configure(AuthenticationManagerBuilder auth) throws Exception {
    // 设置使用内在签名验证
    auth.inMemeoryAuthentication()
        // 设置使用的密码编码器
        .passwordEncoder(new BCryptPasswordEncoder())
        // 添加用户
        .withUser("admin")
        // 设置用户密码
        .password("123456")
        // 设置用户角色, 可以添加多个角色, roles() 
        // 方法内部实质调用了 .authorities() 方法, 其会在角色名前自动添加前缀 `ROLE_`
        // 如果我们使用 .authorities() 方法, 则需要手动添加前缀
        .roles("USER", "ADMIN")
        // 使用 and() 来连接多个角色
        .and()
        .withUser("user")
        .psssword("123456")
        .roles("USER");
}</code></pre>

<p><code>withUser()</code> 方法返回的是一个用户详情构造器 <code>UserDetailsBuilder</code>, 其还有以下的常用的方法</p>
<ul>
<li><code>accountExpired(boolean)</code> 账号是否过期</li>
<li><code>accountLocked(boolean)</code> 是否锁定账号</li>
<li><code>credentialsExpired(boolean)</code> 定义凭证是否过期</li>
<li><code>disabled(boolean)</code> 是否禁用用户</li>
<li><code>username(String)</code> 定义用户名</li>
</ul>
<h5>2.2 使用数据库定义用户认证服务</h5>
<p><code>AuthenticationManagerBuilder#jdbcAuthentication</code> 方法会返回  <code>JdbcUserDetailsManagerConfigurer</code> 对象, 数据库用户表为  <code>org.springframework.security.core.userdetails.User</code>, 数据库至少要实现 4 个字段(<code>id</code>, <code>username</code>, <code>password</code>, <code>available</code>), 并且这顺序是固定的, 另外角色的权限表, 权限表要实现 2 个字段(<code>id</code>, <code>name</code>), 并且顺序也是固定的, 角色权限查询返回的是一个 List.</p>
<p>如果没有实现自己的查询方法, 则会使用内部的查询类 <code>org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl</code></p>
<pre class="highlight line-numbers"><code class="language-java linenums">@Override
protected void configure(AuthenticationManagerBuilder auth) throws Exception {
    // 使用 JDBC 认证
    auth.jdbcAuthentication()
        .passwordEncoder(new BCryptPasswordEncoder())
        .dataSource(dataSource)
        // 设置使用 username 查询的 SQL
        .usersByUsernameQuery("SELECT user_name, pwd, available FROM t_user " +
                              " WHERE user_name = ?")
        // 设置查询角色的 SQL
        .authoritiesByUsernameQuery("SELECT u.user_name, r.role_name FROM " + 
                                    " t_user u, t_user_role ur, t_role r WHERE " +
                                    " u.id = ur.user_id AND r.id = ur.role_id AND " +
                                    " u.user_name = ?");
}</code></pre>

<p>如果需要实现自己的查询处理, 那么可以使用 <code>AuthenticationManagerBuilder#userDetailsService()</code> 方法, 其参数是实现了 <code>UserDetailsService</code> 接口的类, 只有一个方法 <code>loadUserByUsername</code>, 该方法返回 <code>UserDetails</code> 对象, 需要自己实现该接口</p>
<pre class="highlight line-numbers"><code class="language-java linenums">// 用户模型
public class User implements UserDetails {
    private String username;
    private String password;
    private boolean isEnabled;
    private boolean isAccountNonExpired;
    private boolean isAccountNonLocked;
    private boolean isCredentialsNonExpired;
    private List&lt;? extends GrantedAuthority&gt; authorities;

    public User(String username, String password, boolean enabled,
               isAccountNonExpired, isAccountNonLocked, isCredentialsNonExpired,
               authorities) {
        // 这些值从数值库中查出后传入
        this.username = username;
        this.password = password;
        this.enabled = enabled;
        this.isAccountNonExpired = isAccountNonExpired;
        this.isAccountNonLocked = isAccountNonLocked;
        this.isCredentialsNonExpired = isCredentialsNonExpired;
        this.authorities = authorities;
    }
    // getter and setter ...
}


// WebMvcSecurity 配置
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    private JdbcTemplate jdbcTemplate;
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService((username) -&gt; jdbcTemplate.queryForObject(userQuery,
                (rs, rowNum) -&gt; {
            if (rs.isAfterLast()) {
                return null;
            }
            // 假设数据库用户为 id, username, password, enabled
            String password = rs.getString(2);
            boolean enabled = rs.getInt(3) == 1;
            return new User(username, password, enabled);
        }, username))
            // 设置密码编码方式
            .passwordEncoder(new BCryptPasswordEncoder());
    }
}</code></pre>

<h4>3. 限制请求(对 url 的配置)</h4>
<p>限制请求主要是对不同的路径(url)实现不同的策略, 通过这能够实现对不同角色赋予不同权限.</p>
<pre class="highlight line-numbers"><code class="language-java linenums">@Override
protected void configure(HttpSecurity http) throws Exception {
    // 开启认证
    http.authorizeRequests()   
        // Ant 风格匹配, 限定 /user/welcome, /user/details 的访问必须为 ADMIN 或 USER 
        .anMatchers("/user/welcome", "/user/details").hasAnyRole("ADMIN", "USER")
        // /admin 下的 url, 注意 hasAuthority 的角色名称, 自动添加 ROLE_ 前缀
        .antMatchers("/admin/**").hasAuthority("ROLE_ADMIN")
        // 其他任何路径都允许访问
        .anyReuqest().permitAll()
        .and().anonymous()
        // Spring Security 默认的登录页面
        .and().formLogin()
        // 开启 HTTP 基础验证
        .and().httpBasic();
}</code></pre>

<ul>
<li><code>access(String)</code> 参数为 SpEL, 返回 true 则允许访问</li>
<li><code>anonymous()</code> 允许匿名访问</li>
<li><code>authorizeRequest()</code> 限定通过签名请求</li>
<li><code>anyRequest()</code> 限定任意的请求</li>
<li><code>hasAnyRole(String...)</code> 将访问权限赋予多个角色(自动添加前缀 ROLE_)</li>
<li><code>hasRole(String)</code> 将访问权限赋予一个角色</li>
<li><code>permitAll()</code> 无条件允许访问</li>
<li><code>and()</code> 连接词</li>
<li><code>httpBasic()</code> 启动浏览器 HTTP 基础验证</li>
<li><code>formLogin()</code> 启用默认的登录页面</li>
<li><code>not()</code> 对其他方法的访问采取求反</li>
<li><code>fullyAuthenticated()</code> 如果是完整验证(并非 Remember-me), 则允许访问</li>
<li><code>denyAll()</code> 不允许访问</li>
<li><code>hasIpAddress(String)</code> 指定 IP 可以访问</li>
<li><code>rememberme()</code> 开启 remember-me 功能</li>
<li><code>hasAuthority(String)</code> 指定角色可以访问, 需要自己添加前缀 ROLE_</li>
<li><code>hasAnyAuthority(String...)</code> 指定的多角定可以访问, 需要自己添加前缀 ROLE_</li>
<li><code>regexMatchers(String)</code> 正则表达式匹配</li>
</ul>
<p>有时候我们需要更加强大的验证功能, 可以使用 SpEL(Spring 表达式), 比如 <code>access("hasRole('USER') or hasRole('ADMIN')")</code> 来表示需要 USER 或 ADMIN 角色</p>
<h4>3.1. 自定义登录页面</h4>
<p>在登录页面都有一个 Remember Me 的功能, 默认的实现是<strong>记住一天</strong>, 记录在浏览器的 Cookie 中, 其键为 <code>remember-me-key</code>, 其值为 MD5 Hash 过的值</p>
<pre class="highlight line-numbers"><code class="language-java linenums">@Override
protected void configure(HttpSecurity http) throws Exception {
    http.authorizeRequests().antMatchers("/admin/**").access("hasRole('ADMIN')")
        // 启用 remember me 功能, 设置其时间限制和 cookie key
        .and().rememberMe().tokenValiditySeconds(7 * 24 * 3600).key("remember-me")
        .and().authorizeRequests().antMatchers("/**").permitAll()
        // 设置自定义的登录路由
        .and().formLogin().loginPage("/login/page")
        // 设置登录成功后的跳转路径
        .defaultSuccessUrl("/admin/welcome")
        // 设置自定义登出路由
        .and().logout().logoutUrl("/logout/page")
        // 登出后跳转页面
        .logoutSuccessUrl("/welcome");
}</code></pre>

<h4>5. 防止跨站请求伪造(CSRF)</h4>
<p>添加 Spring Security 后, 会自动添加 CSRF 认证, 可以使用 <code>HttpSecurity#csrf().disable()</code> 来关闭. Spring Security 会生成一个 <code>_csrf</code> 变量, 可以在页面模版中使用这个变量</p>
<pre class="highlight line-numbers"><code class="language-html linenums">&lt;input type=hidden id="${_csrf.parameterName}" name="${_csrf.parameterName}" 
    value="${_csrf.token}"&gt;</code></pre>

                <hr style="visibility: hidden;">
                <ul class="pager">
                </ul>
                <hr style="visibility: hidden;">

            </div>  
        </div>
    </article>
</div>

        <script src="/theme/js/jquery.min.js"></script>
        <script src="/theme/js/bootstrap.min.js"></script>
        <script src="/theme/js/prism.js"></script>
        <script src="/theme/js/hux-blog.min.js"></script>
        <script src="/theme/js/snackbar.js"></script>
        <script src="/theme/js/sw-registration.js"></script>
        <!--fastClick.js -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>

        <!-- Google Analytics -->
        <script>
            var _gaId = "UA-113622715-2";
            var _gaDomain = "";

            // Originial
            (function(i, s, o, g, r, a, m) {
                i["GoogleAnalyticsObject"] = r;
                (i[r] =
                    i[r] ||
                    function() {
                        (i[r].q = i[r].q || []).push(arguments);
                    }),
                    (i[r].l = 1 * new Date());
                (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m);
            })(
                window,
                document,
                "script",
                "//www.google-analytics.com/analytics.js",
                "ga"
            );

            ga("create", _gaId, _gaDomain);
            ga("send", "pageview");
        </script>


<script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js"></script>
 
        
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->

                <p class="copyright text-muted">
                    Copyright &copy; Ambertime 2019                    <br>
                    Powered by <a href="http://getpelican.com/">Pelican</a> | Theme by <a href="http://huangxuan.me">HuxPro</a>
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=ivicel&repo=ivicel.github.io&type=star&count=true" >
                    </iframe>
                    
                </p>
            </div>
        </div>
    </div>
</footer> 
        
        <script src="/theme/js/jquery.min.js"></script>
        <script src="/theme/js/bootstrap.min.js"></script>
        <script src="/theme/js/prism.js"></script>
        <script src="/theme/js/hux-blog.min.js"></script>
        <script src="/theme/js/snackbar.js"></script>
        <script src="/theme/js/sw-registration.js"></script>
        <!--fastClick.js -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>

        <!-- Google Analytics -->
        <script>
            var _gaId = "UA-113622715-2";
            var _gaDomain = "";

            // Originial
            (function(i, s, o, g, r, a, m) {
                i["GoogleAnalyticsObject"] = r;
                (i[r] =
                    i[r] ||
                    function() {
                        (i[r].q = i[r].q || []).push(arguments);
                    }),
                    (i[r].l = 1 * new Date());
                (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m);
            })(
                window,
                document,
                "script",
                "//www.google-analytics.com/analytics.js",
                "ga"
            );

            ga("create", _gaId, _gaDomain);
            ga("send", "pageview");
        </script>


<script src="//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js"></script>
    </body>
</html>