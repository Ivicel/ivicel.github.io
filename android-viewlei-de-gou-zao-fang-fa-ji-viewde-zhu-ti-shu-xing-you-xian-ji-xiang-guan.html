<!DOCTYPE html>
<html lang="zh">
    <head>
          <meta charset="utf-8" />
        <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


        <title>
Android View类的构造方法及View的主题属性优先级相关        </title>


        <meta name="HandheldFriendly" content="True" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="referrer" content="origin" />
        <meta name="generator" content="Pelican" />
        <link
            rel="icon"
            type="image/png"
            href="/assets/images/favicon.png"
        />
        <link href="/" rel="canonical" />

        <!-- Feed -->
         
        <link
            href="/theme/css/style.css"
            type="text/css"
            rel="stylesheet"
        />

        <!-- Code highlight color scheme -->
        <link
            href="/theme/css/code_blocks/github.css"
            rel="stylesheet"
        />
         <!-- CSS specified by the user -->
  
        <link href="/assets/css/prism.css" type="text/css" rel="stylesheet" />
  
        <link href="/assets/css/base.css" type="text/css" rel="stylesheet" />
  
        <link href="/assets/css/base-control.css" type="text/css" rel="stylesheet" />
  
        <link href="/assets/css/github.css" type="text/css" rel="stylesheet" />
  
        <link href="/assets/css/codemirror.css" type="text/css" rel="stylesheet" />
  
        <link href="/assets/css/ivicel.css" type="text/css" rel="stylesheet" />
 
        <!-- Custom fonts -->
        <link
            href="https://fonts.googleapis.com/css?family=Montserrat:400,300"
            rel="stylesheet"
            type="text/css"
        />
        <link
            href="https://fonts.googleapis.com/css?family=Lato"
            rel="stylesheet"
            type="text/css"
        />

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->


  <link href="/android-viewlei-de-gou-zao-fang-fa-ji-viewde-zhu-ti-shu-xing-you-xian-ji-xiang-guan.html" rel="canonical" />

    <meta name="description" content="1. layout 里 view 的属性赋值 一个 layout 文件里的 view 的属性可以在 5 个地方赋值 , 优先级从高到低如下 : layout 中对属性直接赋值 layout 中覆盖 view 的 style 构造方法里的 defStyleAttr...">

    <meta name="author" content="ivicel">

    <meta name="tags" content="view">
    <meta name="tags" content="构造方法">
    <meta name="tags" content="attrs">
    <meta name="tags" content="declare-styleable">
    <meta name="tags" content="style">




<!-- Open Graph -->
<meta property="og:site_name" content="Ambertime"/>
<meta property="og:title" content="Android View类的构造方法及View的主题属性优先级相关"/>
<meta property="og:description" content="1. layout 里 view 的属性赋值 一个 layout 文件里的 view 的属性可以在 5 个地方赋值 , 优先级从高到低如下 : layout 中对属性直接赋值 layout 中覆盖 view 的 style 构造方法里的 defStyleAttr..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/android-viewlei-de-gou-zao-fang-fa-ji-viewde-zhu-ti-shu-xing-you-xian-ji-xiang-guan.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2018-04-22 00:00:00+08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/ivicel.html">
<meta property="article:section" content="misc"/>
<meta property="article:tag" content="view"/>
<meta property="article:tag" content="构造方法"/>
<meta property="article:tag" content="attrs"/>
<meta property="article:tag" content="declare-styleable"/>
<meta property="article:tag" content="style"/>
<meta property="og:image" content="/theme/images/post-bg.jpg">

<!-- Twitter Card -->

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Android View类的构造方法及View的主题属性优先级相关",
  "headline": "Android View类的构造方法及View的主题属性优先级相关",
  "datePublished": "2018-04-22 00:00:00+08:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "ivicel",
    "url": "/author/ivicel.html"
  },
  "image": "/theme/images/post-bg.jpg",
  "url": "/android-viewlei-de-gou-zao-fang-fa-ji-viewde-zhu-ti-shu-xing-you-xian-ji-xiang-guan.html",
  "description": "1. layout 里 view 的属性赋值 一个 layout 文件里的 view 的属性可以在 5 个地方赋值 , 优先级从高到低如下 : layout 中对属性直接赋值 layout 中覆盖 view 的 style 构造方法里的 defStyleAttr..."
}
</script>    </head>
    <!-- TODO : Body class -->
    <body class="home-template">
<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>

              <li role="presentation"><a href="/pages/about.html">About</a></li>
              <li role="presentation"><a href="/pages/archives.html">Archives</a></li>
              <li role="presentation"><a href="/pages/category.html">Category</a></li>

    </ul>
  </div>
</nav>     <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="blog-header" >
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="/" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
          </span>
        </nav>
        <h1 class="post-title">Android View类的构造方法及View的主题属性优先级相关</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="/author/ivicel.html">Ivicel</a>
            | <time datetime="Sun 22 April 2018">Sun 22 April 2018</time>
        </span>
        <!-- TODO : Modified check -->
      </div>
    </header>

        <section id="wrapper">
            <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <h3 id="1-layout-view">1. layout 里 view 的属性赋值 </h3>
<p> 一个 layout 文件里的 view 的属性可以在 5 个地方赋值 , 优先级从高到低如下 :</p>
<ul>
<li>layout 中对属性直接赋值  </li>
<li>layout 中覆盖 view 的 style </li>
<li> 构造方法里的 defStyleAttr </li>
<li> 构造方法里的 defStyleRes, 这个当仅当 defStyleAttr 值为 0 , 或者其指定的 attr 值找不到 ( 比如没设定 )</li>
<li>
<p> 定义 / 使用的主题里的值 </p>
</li>
<li>
<p> 在 <strong>layout</strong> 布局文件里对 view 直接赋值 </p>
</li>
</ul>
<pre class="highlight"><code class="language-xml linenums">&lt;TextView
 android:textColor="#332211"/&gt;</code></pre>

<ol>
<li> 自定义一个 <code>style</code>, 然后在 <code>layout</code> 里的 <code>view</code> 使用 <code>style</code> 属性来覆盖 . </li>
</ol>
<p> 影响该 <code>view</code> 以及其子 <code>view</code>. 只有 <code>view</code> 有对应属性时才进行替换 </p>
<pre class="highlight"><code class="language-xml linenums">&lt;style name="MyTextStyle"&gt;
    &lt;item name="android:textColor"&gt;
&lt;/style&gt;
&lt;!-- 直接对 view 使用 --&gt;
&lt;TextView
 style="@style/MyTextStyle"/&gt;
&lt;!-- 对 ViewGroup 使用 , 影响子 view --&gt;
&lt;LinearLayout
 style="@style/MyTextStyle"&gt;

 &lt;TextView
     android:text="inherit from ViewGroup textColor"/&gt;  

    &lt;!-- 没有 textColor 属性 , 无影响 --&gt;
    &lt;ImageView
     android:src="@drawable/welcome.png"/&gt;
&lt;/LinearLayout&gt;
</code></pre>

<ol>
<li>Default Style Attribute (defStyleAttr)</li>
</ol>
<p> 在 <code>TextView</code> 的源代码里有一个构造方法是这样的 </p>
<pre class="highlight"><code class="language-java linenums">public TextView(Context context, @Nullable AttributeSet attrs) {
    this(context, attrs, com.android.internal.R.attr.textViewStyle);
}</code></pre>

<p><code>com.android.internal.R.attr.textViewStyle</code> 是一个 frameworks 层定义的 <a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/master/core/res/res/values/attrs.xml">attr</a>. </p>
<pre class="highlight"><code class="language-xml linenums">&lt;resources&gt;
    &lt;!-- These are the standard attributes that make up a complete theme. --&gt;
    &lt;declare-styleable name="Theme"&gt;
        &lt;!-- ... --&gt;
        &lt;!-- Default TextView style. --&gt;
        &lt;attr name="textViewStyle" format="reference" /&gt;
        &lt;!-- .... --&gt;
 &lt;declare-styleable&gt;
&lt;/resources&gt;</code></pre>

<p> 可以看到这个 attr 类型是一个引用 , 所以当我们这样定义一个 style item 时 </p>
<pre class="highlight"><code class="language-xml linenums">&lt;style name="AppTheme" parent="Theme.AppCompat.Light.DarkActionBar"&gt;
    &lt;item name="android:textColor"&gt;@android:color/holo_green_dark&lt;/item&gt;
    &lt;!-- 由于 defStyleAttr 的优先级比主题的高 , 
     所以 textColor 被覆盖为 holo_blue_light, 即使上面定义了 textColor
 --&gt;
    &lt;item name="android:textViewStyle"&gt;@style/BlueTextStyle&lt;/item&gt;
&lt;/style&gt;

&lt;style name="BlueTextStyle"&gt;
    &lt;item name="android:textColor"&gt;@android:color/holo_blue_light&lt;/item&gt;
&lt;/style&gt;</code></pre>

<ol>
<li>Default Style Resource (defStyleRes)</li>
</ol>
<p> 构造方法 <code>public View(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes)</code> 是在 SDK 21 之后才有的 , 但 defStyleRes 的值是早之前就有使用的 . 这个是一个 <code>R.style.[name]</code> 值 , 只有当 defStyleAttr 为 0 或者查找不到时才有效 </p>
<blockquote>
<p> 需要注意的是 , <code>defStyleAttr</code> 里要求的是一个 format="reference" 的 attr, 但其实质上是一个整型值 , 并且代码中没有用 @AttrRes 来注释 , 所以随便传一个整型值时 , 便可能是相当于 defStyleAttr 不存在 . 同理 <code>defStyleRes</code> 要求的是一个 style id</p>
</blockquote>
<ol>
<li> 在主题文件里赋值 , 比如我们在 <code>styles.xml</code> 里自定义了一个主题 <code>AppTheme</code>. </li>
</ol>
<p> 这个主题可以在 <code>activity</code> 里覆盖 , 也可以设置为程序的默认主题 </p>
<pre class="highlight"><code class="language-xml linenums">&lt;!-- 比如我们在 styles.xml 里自定义一个主题 , 覆盖 andorid:textColor 后 , 
 使用该主题的 view 中有 android:textColor 这个属性的会使用我们设定的值
 因为我们定义的是一个应用的主题 , 而不是单独某个 view 下的某些个属性
 所以这个主题需要继承系统的主题 , 然后再覆盖 , 下面继承的是 support 包里的兼容主题
 --&gt;
&lt;style name="AppTheme" parent="Theme.AppCompat.Light.DarkActionBar"&gt;
    &lt;item name="android:textColor"&gt;@color/myTextColor&lt;/item&gt;
&lt;/style&gt;

&lt;!-- 设置好一个程序的主题文件后 , 我们可以在 AndroidManifest.xml 中引用 --&gt;
&lt;!-- 应用全局主题 --&gt;
&lt;application
 android:theme="@style/AppTheme"/&gt;

&lt;!-- 在 activity 配置里引用 , 这会覆盖掉全局 application 里的设置 --&gt;
&lt;activity
 android:theme="@style/AppTheme"/&gt;</code></pre>

<h3 id="2">2. 构造方法介绍 </h3>
<p> 以 SDK 27 中的 <code>ImageView</code> 为例 , 一共有 4 个构造方法 , 如下 </p>
<pre class="highlight"><code class="language-java linenums">public ImageView(Context context) {
        super(context);
        initImageView();
}

public ImageView(Context context, @Nullable AttributeSet attrs) {
    this(context, attrs, 0);
}

public ImageView(Context context, @Nullable AttributeSet attrs, int defStyleAttr) {
    this(context, attrs, defStyleAttr, 0);
}

public ImageView(Context context, @Nullable AttributeSet attrs, int defStyleAttr,
        int defStyleRes) {
    super(context, attrs, defStyleAttr, defStyleRes);
    /* .... */
}</code></pre>

<p> 构造方法最多有 4 个参数 , 简单意思如下 :</p>
<ul>
<li><code>context</code> 每个构造方法都有 , 用来 inflate, 获取各种参数值等 . 如果我们从 Java 代码中直接创建一个新的 view, 一般都是使用只有 context 的参数的构造方法 </li>
<li><code>attrs</code> 这个是对布局文件 layout.xml 里的解析后生成的对象 , 可以获取到 xml 里的配置 </li>
<li><code>defStyleAttr</code> 属性引用 </li>
<li><code>defStyleRes</code> SDK 21 后增加的 . 如果 minSdkVersion &gt; 21 时才使用这个参数 . 不然使用 <code>Theme#obtainStyledAttributes()</code> 也可以解析 </li>
</ul>
<p> 在 View inflate 后 , 其所以设置属性都解析到了参数 attrs 中 . 可以通过 <code>AttributeSet#getAttributeName()</code>, <code>AttributeSet#getAttributeValue()</code> 来获得名称和值 . 但这个获得的只能是直接的值 , 如果像 <code>android:text=@string/name"</code> 这样引用 , android 内部都是通过 id 来查找 , 所以也是获得一个 id 值 , 所以我们总是用 <code>Theme</code> 类里的方法来一步解析 , 这样可以直接找到对应的 string 值而不是 id</p>
<blockquote>
<p><code>Context</code> 中也有对应的方法 , 其实质是调用了 context.getTeme.obtainStyledAttributes 而已 </p>
</blockquote>
<pre class="highlight"><code class="language-java linenums">// 从解析好的 AttributeSet 查找
TypedArray obtainStyledAttributes(AttributeSet set, int[] attrs, int defStyleAttr, 
        int defStyleRes)
// 从主题中查找
TypedArray obtainStyledAttributes(int[] attrs)
// 从指定的资源文件查找
TypedArray obtainStyledAttributes(int resId, int[] attrs)</code></pre>

<h3 id="reference">Reference:</h3>
<ol>
<li><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0806/4575.html">http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2016/0806/4575.html</a></li>
<li><a href="https://blog.csdn.net/nbalichaoq/article/details/50550103">https://blog.csdn.net/nbalichaoq/article/details/50550103</a></li>
</ol>
            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=Android View类的构造方法及View的主题属性优先级相关&amp;url=/android-viewlei-de-gou-zao-fang-fa-ji-viewde-zhu-ti-shu-xing-you-xian-ji-xiang-guan.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=/android-viewlei-de-gou-zao-fang-fa-ji-viewde-zhu-ti-shu-xing-you-xian-ji-xiang-guan.html" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
                    </a>
                    <a class="googleplus" href="https://plus.google.com/share?url=/android-viewlei-de-gou-zao-fang-fa-ji-viewde-zhu-ti-shu-xing-you-xian-ji-xiang-guan.html" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="ic ic-googleplus"></i><span class="hidden">Google+</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="/tag/view.html">view</a><a href="/tag/gou-zao-fang-fa.html">构造方法</a><a href="/tag/attrs.html">attrs</a><a href="/tag/declare-styleable.html">declare-styleable</a><a href="/tag/style.html">style</a>                </aside>

                <div class="clear"></div>


                </section>


                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
            <!-- TODO : Body class -->
            <div
                id="body-class"
                style="display: none;"
                class=""
            ></div>

            <footer id="footer">
                <div class="inner">
                    <section class="credits">
      
                        <span class="credits-theme">Theme
                        <a
                            href="https://github.com/arulrajnet/attila"
                            rel="nofollow"
                            >Attila</a
                        ></span>
                        <span class="credits-software">Published with
                        <a
                            href="https://github.com/getpelican/pelican"
                            rel="nofollow"
                            >Pelican</a
                        ></span>
                    </section>
                </div>
            </footer>
        </section>

        <script
            type="text/javascript"
            src="/theme/js/script.js"
        ></script>

        <!-- Script specified by the user -->
           <script type="text/javascript" src="/assets/js/prism.js"></script>
       </body>
</html>